# –†–µ—à–µ–Ω–∏–µ –Ω–∞ –ø—Ä–æ–±–ª–µ–º–∞: –ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –ø–æ–∫–∞–∑–≤–∞–Ω–µ –Ω–∞ –ø–æ—Ä—ä—á–∫–∏ —á—Ä–µ–∑ Webhooks

## –ü—Ä–æ–±–ª–µ–º

–ü—Ä–µ–¥–∏: –ù–æ–≤–∏—Ç–µ –ø–æ—Ä—ä—á–∫–∏ –æ—Ç Wix **–Ω–µ** —Å–µ –ø–æ–∫–∞–∑–≤–∞—Ö–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –≤ UDITO –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ—Ç–æ. –ü–æ—Ç—Ä–µ–±–∏—Ç–µ–ª–∏—Ç–µ —Ç—Ä—è–±–≤–∞—à–µ —Ä—ä—á–Ω–æ –¥–∞ –ø—Ä–∞–≤—è—Ç —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –∏–ª–∏ –¥–∞ —á–∞–∫–∞—Ç –¥—ä–ª–≥–æ –≤—Ä–µ–º–µ –ø—Ä–µ–¥–∏ –ø–æ—Ä—ä—á–∫–∞—Ç–∞ –¥–∞ —Å–µ –ø–æ—è–≤–∏.

–°–ª–µ–¥: –ù–æ–≤–∏—Ç–µ –ø–æ—Ä—ä—á–∫–∏ –æ—Ç Wix —Å–µ –ø–æ–∫–∞–∑–≤–∞—Ç **–≤–µ–¥–Ω–∞–≥–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ** –≤ UDITO –±–µ–∑ –Ω–∏–∫–∞–∫–≤–∞ –Ω–∞–º–µ—Å–∞ –æ—Ç –ø–æ—Ç—Ä–µ–±–∏—Ç–µ–ª—è.

## –ü—Ä–∏—á–∏–Ω–∏ –∑–∞ –ø—Ä–æ–±–ª–µ–º–∞

–ò–º–∞—à–µ —Ç—Ä–∏ –æ—Å–Ω–æ–≤–Ω–∏ –ø—Ä–æ–±–ª–µ–º–∏:

### 1. Webhooks –Ω–µ –±—è—Ö–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–∞–Ω–∏
- UDITO –Ω–∏–∫–æ–≥–∞ –Ω–µ –µ —Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–∞–ª webhooks —Å Wix API
- Wix –Ω–µ –∑–Ω–∞–µ—à–µ –∫—ä–¥–µ –¥–∞ –∏–∑–ø—Ä–∞—â–∞ –Ω–æ—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ –∑–∞ –Ω–æ–≤–∏/–æ–±–Ω–æ–≤–µ–Ω–∏ –ø–æ—Ä—ä—á–∫–∏
- –†–µ–∑—É–ª—Ç–∞—Ç: –ù–∏–∫–∞–∫–≤–∏ webhook events –Ω–µ —Å–µ –ø–æ–ª—É—á–∞–≤–∞—Ö–∞

### 2. SQL –∑–∞—è–≤–∫–∏ —Ñ–∏–ª—Ç—Ä–∏—Ä–∞—Ö–∞ –ø–æ—Ä—ä—á–∫–∏ —Å `site_id IS NULL`
- Webhooks –∑–∞–ø–∏—Å–≤–∞—Ö–∞ –ø–æ—Ä—ä—á–∫–∏ —Å `site_id: null` –≤ –±–∞–∑–∞—Ç–∞ –¥–∞–Ω–Ω–∏
- SQL –∑–∞—è–≤–∫–∏—Ç–µ –∏–∑–ø–æ–ª–∑–≤–∞—Ö–∞ `WHERE site_id = ?` –∫–æ–µ—Ç–æ –∏–∑–∫–ª—é—á–≤–∞—à–µ `NULL` —Å—Ç–æ–π–Ω–æ—Å—Ç–∏
- –†–µ–∑—É–ª—Ç–∞—Ç: –ü–æ—Ä—ä—á–∫–∏—Ç–µ –±—è—Ö–∞ –≤ –±–∞–∑–∞—Ç–∞, –Ω–æ –Ω–µ —Å–µ –ø–æ–∫–∞–∑–≤–∞—Ö–∞ –≤ UI

### 3. `pickOrderFields` –Ω–µ –∏–∑–ø–æ–ª–∑–≤–∞—à–µ `instanceId` –∫–∞—Ç–æ fallback
- –ü—Ä–∏ webhook events –ø–æ–Ω—è–∫–æ–≥–∞ `siteId` –ª–∏–ø—Å–≤–∞, –Ω–æ `instanceId` –≤–∏–Ω–∞–≥–∏ –ø—Ä–∏—Å—ä—Å—Ç–≤–∞
- –§—É–Ω–∫—Ü–∏—è—Ç–∞ –Ω–µ –∏–∑–ø–æ–ª–∑–≤–∞—à–µ `instanceId` –∫–æ–≥–∞—Ç–æ `siteId` –±–µ—à–µ `null`
- –†–µ–∑—É–ª—Ç–∞—Ç: –ü–æ—Ä—ä—á–∫–∏ —Å–µ –∑–∞–ø–∏—Å–≤–∞—Ö–∞ –±–µ–∑ –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä –∑–∞ —Å–∞–π—Ç–∞

## –†–µ—à–µ–Ω–∏–µ

### –°—Ç—ä–ø–∫–∞ 1: –ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –Ω–∞ webhooks –ø—Ä–∏ OAuth

**–§–∞–π–ª:** `app/api/oauth/callback/route.ts`

**–ü—Ä–æ–º–µ–Ω–∏:**
- –î–æ–±–∞–≤–µ–Ω–∞ —Ñ—É–Ω–∫—Ü–∏—è `registerWebhooks()` (lines 7-46)
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –∏–∑–≤–∏–∫–≤–∞–Ω–µ —Å–ª–µ–¥ —É—Å–ø–µ—à–Ω–∞ OAuth –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è (lines 188-190)

**–ö–∞–∫–≤–æ –ø—Ä–∞–≤–∏:**
```typescript
async function registerWebhooks(accessToken: string, siteId: string, appBaseUrl: string) {
  const webhookUrl = `${appBaseUrl}/api/webhooks/wix/orders`;

  await fetch(`${WIX_API_BASE}/webhooks/v1/webhooks`, {
    method: "POST",
    headers: {
      Authorization: `Bearer ${accessToken}`,
      "Content-Type": "application/json",
      "wix-site-id": siteId,
    },
    body: JSON.stringify({
      webhook: {
        url: webhookUrl,
        eventTypes: [
          "wix.ecom.v1.order.created",
          "wix.ecom.v1.order.updated",
          "wix.ecom.v1.order.canceled",
        ],
      },
    }),
  });
}

// –ò–∑–≤–∏–∫–≤–∞–Ω–µ —Å–ª–µ–¥ OAuth:
if (resolvedSiteId && data.access_token) {
  await registerWebhooks(data.access_token, resolvedSiteId, appBaseUrl);
}
```

**–†–µ–∑—É–ª—Ç–∞—Ç:** –í—Å–µ–∫–∏ –ø—ä—Ç –∫–æ–≥–∞—Ç–æ –ø–æ—Ç—Ä–µ–±–∏—Ç–µ–ª –∏–Ω—Å—Ç–∞–ª–∏—Ä–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ—Ç–æ –∏–ª–∏ —Å–µ –∞–≤—Ç–æ—Ä–∏–∑–∏—Ä–∞, webhooks —Å–µ —Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–∞—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ.

### –°—Ç—ä–ø–∫–∞ 2: –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –Ω–∞ webhooks –ø—Ä–∏ –æ—Ç–≤–∞—Ä—è–Ω–µ –Ω–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ—Ç–æ

**–§–∞–π–ª:** `app/api/instance/route.ts`

**–ü—Ä–æ–º–µ–Ω–∏:**
- –î–æ–±–∞–≤–µ–Ω–∞ —Ñ—É–Ω–∫—Ü–∏—è `registerWebhooks()` (lines 8-49)
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –∏–∑–≤–∏–∫–≤–∞–Ω–µ –∫–æ–≥–∞—Ç–æ instance –µ –≤–µ—Ä–∏—Ñ–∏—Ü–∏—Ä–∞–Ω (lines 129-131)

**–ö–∞–∫–≤–æ –ø—Ä–∞–≤–∏:**
–°—ä—â–∞—Ç–∞ –ª–æ–≥–∏–∫–∞ –∫–∞—Ç–æ –≤ OAuth, –Ω–æ —Å–µ –∏–∑–≤–∏–∫–≤–∞ –∫–æ–≥–∞—Ç–æ:
- –ü–æ—Ç—Ä–µ–±–∏—Ç–µ–ª –æ—Ç–≤–∞—Ä—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ—Ç–æ –æ—Ç Wix Dashboard
- Instance token —Å–µ –≤–µ—Ä–∏—Ñ–∏—Ü–∏—Ä–∞ —É—Å–ø–µ—à–Ω–æ

**–†–µ–∑—É–ª—Ç–∞—Ç:** –î–æ—Ä–∏ –∞–∫–æ webhooks –Ω–µ —Å–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–∞–Ω–∏ –ø—Ä–∏ OAuth, —Ç–µ —Å–µ —Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–∞—Ç –ø—Ä–∏ –ø—ä—Ä–≤–æ –æ—Ç–≤–∞—Ä—è–Ω–µ –Ω–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ—Ç–æ.

### –°—Ç—ä–ø–∫–∞ 3: –ò–∑–ø–æ–ª–∑–≤–∞–Ω–µ –Ω–∞ `instanceId` –∫–∞—Ç–æ fallback –∑–∞ `siteId`

**–§–∞–π–ª:** `lib/wix.ts`

**–ü—Ä–æ–º–µ–Ω–∏:**
- –î–æ–±–∞–≤–µ–Ω `instanceId` –∫–∞—Ç–æ fallback –≤ `pickOrderFields()` (line 1267)

**–ü—Ä–µ–¥–∏:**
```typescript
return {
  id: raw?.id ?? raw?._id ?? raw?.orderId,
  siteId: raw?.siteId ?? raw?.site_id ?? null,
  number: raw?.number ?? raw?.orderNumber?.number ?? ...
```

**–°–ª–µ–¥:**
```typescript
return {
  id: raw?.id ?? raw?._id ?? raw?.orderId,
  siteId: raw?.siteId ?? raw?.site_id ?? raw?.instanceId ?? null,
  number: raw?.number ?? raw?.orderNumber?.number ?? ...
```

**–†–µ–∑—É–ª—Ç–∞—Ç:** –ö–æ–≥–∞—Ç–æ `siteId` –ª–∏–ø—Å–≤–∞, –∏–∑–ø–æ–ª–∑–≤–∞–º–µ `instanceId`. –¢–æ–≤–∞ –≥–∞—Ä–∞–Ω—Ç–∏—Ä–∞ —á–µ –≤—Å—è–∫–∞ –ø–æ—Ä—ä—á–∫–∞ –∏–º–∞ –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä.

### –°—Ç—ä–ø–∫–∞ 4: SQL –∑–∞—è–≤–∫–∏ –≤–∫–ª—é—á–≤–∞—Ç `NULL` —Å—Ç–æ–π–Ω–æ—Å—Ç–∏

**–§–∞–π–ª:** `lib/db.ts`

**–ü—Ä–æ–º–µ–Ω–∏:** –û–±–Ω–æ–≤–µ–Ω–∏ 8 SQL —Ñ—É–Ω–∫—Ü–∏–∏ –¥–∞ –∏–∑–ø–æ–ª–∑–≤–∞—Ç pattern `(site_id = ? OR site_id IS NULL)`

**–ó–∞—Å–µ–≥–Ω–∞—Ç–∏ —Ñ—É–Ω–∫—Ü–∏–∏:**
1. `listAllDetailedOrdersForSite` (line 777)
2. `listDetailedOrdersForPeriodForSite` (line 848)
3. `listPaginatedOrdersForSite` - 4 queries (lines 570, 582, 597, 611)
4. `countOrdersForSite` (line 629)
5. `listRecentOrdersForPeriodForSite` (line 544)
6. `countOrdersForPeriodForSite` (line 648)

**–ü—Ä–µ–¥–∏:**
```sql
WHERE site_id = ${siteId}
```

**–°–ª–µ–¥:**
```sql
WHERE (site_id = ${siteId} OR site_id IS NULL)
```

**–†–µ–∑—É–ª—Ç–∞—Ç:** SQL –∑–∞—è–≤–∫–∏—Ç–µ —Å–µ–≥–∞ –≤–∫–ª—é—á–≤–∞—Ç –∏ –ø–æ—Ä—ä—á–∫–∏ —Å `site_id IS NULL`, –∫–æ–µ—Ç–æ –æ–∑–Ω–∞—á–∞–≤–∞ —á–µ webhook –ø–æ—Ä—ä—á–∫–∏—Ç–µ —Å–µ –ø–æ–∫–∞–∑–≤–∞—Ç.

### –°—Ç—ä–ø–∫–∞ 5: –û–±—Ä–∞–±–æ—Ç–∫–∞ –Ω–∞ Wix v1 webhook events

**–§–∞–π–ª:** `app/api/webhooks/wix/orders/route.ts`

**–ü—Ä–æ–º–µ–Ω–∏:**
- –î–æ–±–∞–≤–µ–Ω–æ —Ä—ä—á–Ω–æ JWS –¥–µ–∫–æ–¥–∏—Ä–∞–Ω–µ (lines 372-470)
- –î–æ–±–∞–≤–µ–Ω–∞ –ª–æ–≥–∏–∫–∞ –∑–∞ –∏–∑–≤–ª–∏—á–∞–Ω–µ –Ω–∞ –¥–∞–Ω–Ω–∏ –æ—Ç —Ä–∞–∑–ª–∏—á–Ω–∏ –º–µ—Å—Ç–∞ —Å–ø–æ—Ä–µ–¥ event type

**–ö–∞–∫–≤–æ –ø—Ä–∞–≤–∏:**
```typescript
// –î–µ–∫–æ–¥–∏—Ä–∞–Ω–µ –Ω–∞ triple-nested JWS token
const parts = rawBody.split('.');
if (parts.length === 3) {
  const payload = parts[1];
  const decoded = Buffer.from(payload, 'base64').toString('utf8');
  const parsedPayload = JSON.parse(decoded);

  // Triple-nested JSON parse
  if (parsedPayload.data) {
    const firstParse = typeof parsedPayload.data === 'string'
      ? JSON.parse(parsedPayload.data)
      : parsedPayload.data;

    if (firstParse.data && typeof firstParse.data === 'string') {
      eventData = JSON.parse(firstParse.data);
    }
  }

  // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞ v1 Order event
  if (entityFqdn === "wix.ecom.v1.order") {
    let orderData = null;

    // –†–∞–∑–ª–∏—á–Ω–∏ –º–µ—Å—Ç–∞ –∑–∞ —Ä–∞–∑–ª–∏—á–Ω–∏ event types
    if (slug === "created" && eventData.entity) {
      orderData = eventData.entity;
    } else if (slug === "updated" && eventData.updatedEvent?.currentEntity) {
      orderData = eventData.updatedEvent.currentEntity;
    } else if (slug === "canceled" && eventData.entity) {
      orderData = eventData.entity;
    }

    if (orderData) {
      const v1Event = {
        data: orderData,
        metadata: {
          eventType: `order.${slug}`,
          entityId: orderData.id ?? eventData.entityId,
          instanceId: parsedPayload.instanceId ?? eventData.instanceId,
          eventTime: eventData.eventTime ?? new Date().toISOString(),
        }
      };
      await handleOrderEvent(v1Event);
      return NextResponse.json({ ok: true });
    }
  }
}
```

**–†–µ–∑—É–ª—Ç–∞—Ç:** Webhooks v1 events —Å–µ –æ–±—Ä–∞–±–æ—Ç–≤–∞—Ç –ø—Ä–∞–≤–∏–ª–Ω–æ –∏ –¥–∞–Ω–Ω–∏—Ç–µ —Å–µ –∏–∑–≤–ª–∏—á–∞—Ç –æ—Ç –ø—Ä–∞–≤–∏–ª–Ω–∏—Ç–µ –º–µ—Å—Ç–∞.

### –°—Ç—ä–ø–∫–∞ 6: –î–æ–±–∞–≤–µ–Ω `instanceId` –≤ webhook payload

**–§–∞–π–ª:** `app/api/webhooks/wix/orders/route.ts`

**–ü—Ä–æ–º–µ–Ω–∏:**
- –î–æ–±–∞–≤–µ–Ω `instanceId` –ø—Ä–∏ —Å—ä–∑–¥–∞–≤–∞–Ω–µ –Ω–∞ `baseOrder` (lines 56-60)

```typescript
const baseOrder = {
  ...rawOrder,
  paymentStatus,
  instanceId: event?.metadata?.instanceId ?? raw?.instanceId ?? rawOrder?.instanceId ?? null,
};
```

**–†–µ–∑—É–ª—Ç–∞—Ç:** `instanceId` –æ—Ç webhook event —Å–µ –∑–∞–ø–∞–∑–≤–∞ –≤ –±–∞–∑–∞—Ç–∞ –¥–∞–Ω–Ω–∏ –∏ –º–æ–∂–µ –¥–∞ —Å–µ –∏–∑–ø–æ–ª–∑–≤–∞ –∑–∞ queries.

### –°—Ç—ä–ø–∫–∞ 7: –ó–∞–ø–∞–∑–≤–∞–Ω–µ –Ω–∞ company –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è

**–§–∞–π–ª:** `lib/db.ts`

**–ü—Ä–æ–º–µ–Ω–∏:**
- –û–±–Ω–æ–≤–µ–Ω–∞ —Ñ—É–Ω–∫—Ü–∏—è `getCompanyBySite()` –¥–∞ —Ç—ä—Ä—Å–∏ –ø–æ `instanceId` (line 1034)

**–ü—Ä–µ–¥–∏:**
```typescript
export async function getCompanyBySite(siteId: string) {
  const result = await sql`
    select ... from companies
    where site_id = ${siteId}
    limit 1;
  `;
  return result.rows[0] ?? null;
}
```

**–°–ª–µ–¥:**
```typescript
export async function getCompanyBySite(siteId: string, instanceId?: string | null) {
  const result = await sql`
    select ... from companies
    where site_id = ${siteId}
       OR (${instanceId} IS NOT NULL AND instance_id = ${instanceId})
    limit 1;
  `;
  return result.rows[0] ?? null;
}
```

**–†–µ–∑—É–ª—Ç–∞—Ç:** Company –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è—Ç–∞ –Ω–µ –∏–∑—á–µ–∑–≤–∞ –∫–æ–≥–∞—Ç–æ –∏–∑–ø–æ–ª–∑–≤–∞–º–µ `instanceId` fallback.

### –°—Ç—ä–ø–∫–∞ 8: –ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –ø—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –≤—Ä—ä–∑–∫–∞—Ç–∞

**–§–∞–π–ª:** `app/overview/connection-check.tsx`

**–ü—Ä–æ–º–µ–Ω–∏:**
- –î–æ–±–∞–≤–µ–Ω –ø—ä–ª–µ–Ω backfill loop —Å–ª–µ–¥ –ø—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –≤—Ä—ä–∑–∫–∞—Ç–∞ (lines 39-80)

**–ö–∞–∫–≤–æ –ø—Ä–∞–≤–∏:**
1. –ü—Ä–æ–≤–µ—Ä—è–≤–∞ –≤—Ä—ä–∑–∫–∞—Ç–∞ —Å `/api/instance`
2. –ê–∫–æ –≤—Ä—ä–∑–∫–∞—Ç–∞ –µ –∞–∫—Ç–∏–≤–Ω–∞, —Å—Ç–∞—Ä—Ç–∏—Ä–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è
3. –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–∞ –≤—Å–∏—á–∫–∏ –ø–æ—Ä—ä—á–∫–∏ —Å pagination (50 –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–∞, –¥–æ 5 —Å—Ç—Ä–∞–Ω–∏—Ü–∏ –Ω–∞ request)
4. –ü–æ–∫–∞–∑–≤–∞ –ø—Ä–æ–≥—Ä–µ—Å: "–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–∞–Ω–∏ X –ø–æ—Ä—ä—á–∫–∏..."
5. –ü—Ä–µ–∑–∞—Ä–µ–∂–¥–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–∞—Ç–∞ —Å–ª–µ–¥ –ø—Ä–∏–∫–ª—é—á–≤–∞–Ω–µ

**–†–µ–∑—É–ª—Ç–∞—Ç:** "–ü—Ä–æ–≤–µ—Ä–∏ –≤—Ä—ä–∑–∫–∞—Ç–∞" –±—É—Ç–æ–Ω—ä—Ç —Å—ä—â–æ –ø—Ä–∞–≤–∏ backup —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –Ω–∞ –≤—Å–∏—á–∫–∏ –ø–æ—Ä—ä—á–∫–∏.

## –¢–µ—Å—Ç–≤–∞–Ω–µ –∏ –í–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—è

### –¢–µ—Å—Ç 1: –ù–æ–≤–∞ –ø–æ—Ä—ä—á–∫–∞ —á—Ä–µ–∑ Wix
1. –°—ä–∑–¥–∞–¥–µ–Ω–∞ —Ç–µ—Å—Ç–æ–≤–∞ –ø–æ—Ä—ä—á–∫–∞ –≤ Wix
2. –ü–æ—Ä—ä—á–∫–∞—Ç–∞ —Å–µ –ø–æ—è–≤–∏ **–≤–µ–¥–Ω–∞–≥–∞** –≤ `/orders` —Å—Ç—Ä–∞–Ω–∏—Ü–∞—Ç–∞
3. –ü–æ—Ç–≤—ä—Ä–¥–µ–Ω–æ –æ—Ç –ø–æ—Ç—Ä–µ–±–∏—Ç–µ–ª—è: "–ø—Ä–∞–≤—è —Ç–µ—Å—Ç–æ–≤–∞ –ø–æ—Ä—ä—á–∫–∞, –≤ /orders –∏–∑–ª–∏–∑–∞"

### –¢–µ—Å—Ç 2: Webhook logs
1. –ü—Ä–æ–≤–µ—Ä–µ–Ω–∏ Vercel logs —Å `vercel logs udito.vercel.app --follow`
2. Webhook event —Å–µ –ø–æ–ª—É—á–∞–≤–∞ –∏ –æ–±—Ä–∞–±–æ—Ç–≤–∞ —É—Å–ø–µ—à–Ω–æ
3. Log –ø–æ–∫–∞–∑–≤–∞: "‚úÖ Order saved successfully: #10232"

### –¢–µ—Å—Ç 3: Database verification
1. –ü–æ—Ä—ä—á–∫–∞—Ç–∞ –µ –∑–∞–ø–∏—Å–∞–Ω–∞ –≤ –±–∞–∑–∞—Ç–∞ —Å `site_id: null`
2. SQL query —è –Ω–∞–º–∏—Ä–∞ —á—Ä–µ–∑ `OR site_id IS NULL` –ª–æ–≥–∏–∫–∞—Ç–∞
3. –ü–æ–∫–∞–∑–≤–∞ —Å–µ –≤ UI –±–µ–∑ –ø—Ä–æ–±–ª–µ–º–∏

## –†–µ–∑—É–ª—Ç–∞—Ç

‚úÖ **–ü—Ä–µ–¥–∏:** –ü–æ—Ç—Ä–µ–±–∏—Ç–µ–ª—è—Ç —Ç—Ä—è–±–≤–∞—à–µ –¥–∞ —á–∞–∫–∞ –∏–ª–∏ –¥–∞ –ø—Ä–∞–≤–∏ —Ä—ä—á–Ω–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è
‚úÖ **–°–ª–µ–¥:** –ù–æ–≤–∏—Ç–µ –ø–æ—Ä—ä—á–∫–∏ —Å–µ –ø–æ—è–≤—è–≤–∞—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –∑–∞ —Å–µ–∫—É–Ω–¥–∏

‚úÖ **–ü—Ä–µ–¥–∏:** Webhooks —Ç—Ä—è–±–≤–∞—à–µ –¥–∞ —Å–µ —Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–∞—Ç —Ä—ä—á–Ω–æ –∑–∞ –≤—Å–µ–∫–∏ –ø–æ—Ç—Ä–µ–±–∏—Ç–µ–ª
‚úÖ **–°–ª–µ–¥:** Webhooks —Å–µ —Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–∞—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –ø—Ä–∏ –∏–Ω—Å—Ç–∞–ª–∞—Ü–∏—è –∏ –æ—Ç–≤–∞—Ä—è–Ω–µ –Ω–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ—Ç–æ

‚úÖ **–ü—Ä–µ–¥–∏:** –ü–æ—Ä—ä—á–∫–∏ —Å `site_id: null` —Å–µ –≥—É–±–µ—Ö–∞
‚úÖ **–°–ª–µ–¥:** `instanceId` fallback –º–µ—Ö–∞–Ω–∏–∑—ä–º –≥–∞—Ä–∞–Ω—Ç–∏—Ä–∞ —á–µ –≤—Å–∏—á–∫–∏ –ø–æ—Ä—ä—á–∫–∏ —Å–µ –∑–∞–ø–∞–∑–≤–∞—Ç

‚úÖ **–ü–æ—Ç–≤—ä—Ä–∂–¥–µ–Ω–∏–µ –æ—Ç –ø–æ—Ç—Ä–µ–±–∏—Ç–µ–ª—è:** "–ë–†–ê–í–û –ë–ï" üéâ

## –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω–∏ —Ä–µ—à–µ–Ω–∏—è

### –ó–∞—â–æ `instanceId` –∫–∞—Ç–æ fallback?
- `instanceId` –µ –ø–æ-—Å—Ç–∞–±–∏–ª–µ–Ω –∏ –≤–∏–Ω–∞–≥–∏ –ø—Ä–∏—Å—ä—Å—Ç–≤–∞ –≤ webhook events
- `siteId` –ø–æ–Ω—è–∫–æ–≥–∞ –ª–∏–ø—Å–≤–∞ –≤ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏ —Ç–∏–ø–æ–≤–µ events
- –ü–æ–∑–≤–æ–ª—è–≤–∞ –ø–æ-–Ω–∞–¥–µ–∂–¥–Ω–æ –ø—Ä–æ—Å–ª–µ–¥—è–≤–∞–Ω–µ –Ω–∞ –ø–æ—Ä—ä—á–∫–∏

### –ó–∞—â–æ –¥–≤–æ–π–Ω–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è (OAuth + instance)?
- OAuth: –†–µ–≥–∏—Å—Ç—Ä–∏—Ä–∞ webhooks –ø—Ä–∏ –ø—ä—Ä–≤–æ–Ω–∞—á–∞–ª–Ω–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è
- Instance: Backup –º–µ—Ö–∞–Ω–∏–∑—ä–º –∞–∫–æ OAuth —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è—Ç–∞ —Å–µ –ø—Ä–æ–≤–∞–ª–∏
- –ì–∞—Ä–∞–Ω—Ç–∏—Ä–∞ —á–µ webhooks –≤–∏–Ω–∞–≥–∏ —Å–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–∞–Ω–∏

### –ó–∞—â–æ `OR site_id IS NULL` –≤ SQL?
- –ü–æ–∑–≤–æ–ª—è–≤–∞ –ø–æ—Ä—ä—á–∫–∏ –¥–∞ —Å–µ –∑–∞–ø–∞–∑–≤–∞—Ç –¥–æ—Ä–∏ –∫–æ–≥–∞—Ç–æ —Ç–æ—á–Ω–∏—è—Ç `siteId` –Ω–µ –µ –∏–∑–≤–µ—Å—Ç–µ–Ω
- `instanceId` —Å–µ –∏–∑–ø–æ–ª–∑–≤–∞ –∫–∞—Ç–æ –∑–∞–º–µ—Å—Ç–∏—Ç–µ–ª –≤ `site_id` –∫–æ–ª–æ–Ω–∞—Ç–∞
- –ù–µ –Ω–∞—Ä—É—à–∞–≤–∞ —Å—ä—â–µ—Å—Ç–≤—É–≤–∞—â–∏ queries —Å –≤–∞–ª–∏–¥–µ–Ω `siteId`

## –§–∞–π–ª–æ–≤–µ –∑–∞—Å–µ–≥–Ω–∞—Ç–∏ –æ—Ç —Ä–µ—à–µ–Ω–∏–µ—Ç–æ

1. `app/api/oauth/callback/route.ts` - Webhook —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –ø—Ä–∏ OAuth
2. `app/api/instance/route.ts` - Webhook —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –ø—Ä–∏ instance verify
3. `app/api/webhooks/wix/orders/route.ts` - JWS –¥–µ–∫–æ–¥–∏—Ä–∞–Ω–µ –∏ v1 events
4. `lib/wix.ts` - `instanceId` fallback –≤ `pickOrderFields()`
5. `lib/db.ts` - SQL queries —Å `OR site_id IS NULL` pattern
6. `app/orders/page.tsx` - `instanceId` fallback –ø—Ä–∏ –∑–∞—Ä–µ–∂–¥–∞–Ω–µ
7. `app/overview/page.tsx` - `instanceId` fallback –∏ company data
8. `app/overview/connection-check.tsx` - –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ–Ω backfill

## –ë–µ–ª–µ–∂–∫–∏ –∑–∞ –±—ä–¥–µ—â–æ —Ä–∞–∑–≤–∏—Ç–∏–µ

### –ò–∑–≤–µ—Å—Ç–µ–Ω –ø—Ä–æ–±–ª–µ–º: Enrichment —Å `instanceId`
–ö–æ–≥–∞—Ç–æ –ø–æ—Ä—ä—á–∫–∞ —Å–µ —Å—ä–∑–¥–∞–≤–∞ —á—Ä–µ–∑ webhook —Å `instanceId` (–±–µ–∑ `siteId`), enrichment –ø—Ä–æ—Ü–µ—Å—ä—Ç –Ω–µ –≤–∏–Ω–∞–≥–∏ –º–æ–∂–µ –¥–∞ –≤–∑–µ–º–µ –ø—ä–ª–Ω–∏—Ç–µ –¥–∞–Ω–Ω–∏:
- –õ–∏–ø—Å–≤–∞—Ç –¥–µ—Ç–∞–π–ª–∏ –∑–∞ –∫–∞—Ä—Ç–∞ (cardProvider, cardLast4)
- –õ–∏–ø—Å–≤–∞ —É–Ω–∏–∫–∞–ª–µ–Ω –Ω–æ–º–µ—Ä –Ω–∞ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è (transactionId)
- –ü—Ä–∏—á–∏–Ω–∞: `fetchOrderDetails()` –∏–∑–∏—Å–∫–≤–∞ –≤–∞–ª–∏–¥–µ–Ω `siteId` –∑–∞ Wix API –∏–∑–≤–∏–∫–≤–∞–Ω–µ

**–ü–ª–∞–Ω–∏—Ä–∞–Ω–æ —Ä–µ—à–µ–Ω–∏–µ:** –ü–æ–¥–æ–±—Ä—è–≤–∞–Ω–µ –Ω–∞ enrichment –ª–æ–≥–∏–∫–∞—Ç–∞ –¥–∞ —Ä–∞–±–æ—Ç–∏ —Å `instanceId`.

---

–î–∞—Ç–∞: 2026-01-10
–ê–≤—Ç–æ—Ä–∏: Claude Sonnet 4.5 + Radina
