# UDITO - ĞŸÑŠĞ»ĞµĞ½ ĞĞ½Ğ°Ğ»Ğ¸Ğ· Ğ½Ğ° ĞŸÑ€Ğ¸Ğ»Ğ¾Ğ¶ĞµĞ½Ğ¸ĞµÑ‚Ğ¾

**Ğ”Ğ°Ñ‚Ğ° Ğ½Ğ° Ğ°Ğ½Ğ°Ğ»Ğ¸Ğ·:** 2026-01-17
**Ğ’ĞµÑ€ÑĞ¸Ñ:** 1.0

---

## Ğ¡ÑŠĞ´ÑŠÑ€Ğ¶Ğ°Ğ½Ğ¸Ğµ

1. [ĞšĞ°ĞºĞ²Ğ¾ Ğµ UDITO?](#1-ĞºĞ°ĞºĞ²Ğ¾-Ğµ-udito)
2. [Ğ¢ĞµÑ…Ğ½Ğ¾Ğ»Ğ¾Ğ³Ğ¸Ñ‡ĞµĞ½ ÑÑ‚ĞµĞº](#2-Ñ‚ĞµÑ…Ğ½Ğ¾Ğ»Ğ¾Ğ³Ğ¸Ñ‡ĞµĞ½-ÑÑ‚ĞµĞº)
3. [Ğ¡Ñ‚Ñ€ÑƒĞºÑ‚ÑƒÑ€Ğ° Ğ½Ğ° Ğ¿Ñ€Ğ¾ĞµĞºÑ‚Ğ°](#3-ÑÑ‚Ñ€ÑƒĞºÑ‚ÑƒÑ€Ğ°-Ğ½Ğ°-Ğ¿Ñ€Ğ¾ĞµĞºÑ‚Ğ°)
4. [Ğ‘Ğ°Ğ·Ğ° Ğ´Ğ°Ğ½Ğ½Ğ¸](#4-Ğ±Ğ°Ğ·Ğ°-Ğ´Ğ°Ğ½Ğ½Ğ¸)
5. [API Endpoints](#5-api-endpoints)
6. [ĞšĞ°Ğº Ñ€Ğ°Ğ±Ğ¾Ñ‚Ğ¸ Ğ¿Ñ€Ğ¸Ğ»Ğ¾Ğ¶ĞµĞ½Ğ¸ĞµÑ‚Ğ¾](#6-ĞºĞ°Ğº-Ñ€Ğ°Ğ±Ğ¾Ñ‚Ğ¸-Ğ¿Ñ€Ğ¸Ğ»Ğ¾Ğ¶ĞµĞ½Ğ¸ĞµÑ‚Ğ¾)
7. [Multi-tenant Ğ°Ñ€Ñ…Ğ¸Ñ‚ĞµĞºÑ‚ÑƒÑ€Ğ°](#7-multi-tenant-Ğ°Ñ€Ñ…Ğ¸Ñ‚ĞµĞºÑ‚ÑƒÑ€Ğ°)
8. [ĞĞ°Ğ¼ĞµÑ€ĞµĞ½Ğ¸ Ğ¿Ñ€Ğ¾Ğ±Ğ»ĞµĞ¼Ğ¸](#8-Ğ½Ğ°Ğ¼ĞµÑ€ĞµĞ½Ğ¸-Ğ¿Ñ€Ğ¾Ğ±Ğ»ĞµĞ¼Ğ¸)
9. [ĞŸĞ»Ğ°Ğ½ Ğ·Ğ° Ñ€ĞµÑˆĞ°Ğ²Ğ°Ğ½Ğµ](#9-Ğ¿Ğ»Ğ°Ğ½-Ğ·Ğ°-Ñ€ĞµÑˆĞ°Ğ²Ğ°Ğ½Ğµ)
10. [ĞŸÑ€Ğ¸Ğ¾Ñ€Ğ¸Ñ‚Ğ¸Ğ·Ğ¸Ñ€Ğ°Ğ½ ÑĞ¿Ğ¸ÑÑŠĞº Ğ½Ğ° Ğ·Ğ°Ğ´Ğ°Ñ‡Ğ¸](#10-Ğ¿Ñ€Ğ¸Ğ¾Ñ€Ğ¸Ñ‚Ğ¸Ğ·Ğ¸Ñ€Ğ°Ğ½-ÑĞ¿Ğ¸ÑÑŠĞº-Ğ½Ğ°-Ğ·Ğ°Ğ´Ğ°Ñ‡Ğ¸)

---

## 1. ĞšĞ°ĞºĞ²Ğ¾ Ğµ UDITO?

**UDITO Ğµ SaaS Ğ¿Ñ€Ğ¸Ğ»Ğ¾Ğ¶ĞµĞ½Ğ¸Ğµ Ğ·Ğ° Ğ±ÑŠĞ»Ğ³Ğ°Ñ€ÑĞºĞ¸ e-commerce Ğ¼Ğ°Ğ³Ğ°Ğ·Ğ¸Ğ½Ğ¸ Ñ Wix**, ĞºĞ¾ĞµÑ‚Ğ¾ Ğ°Ğ²Ñ‚Ğ¾Ğ¼Ğ°Ñ‚Ğ¸Ñ‡Ğ½Ğ¾ Ğ¸Ğ·Ğ´Ğ°Ğ²Ğ° **ĞµĞ»ĞµĞºÑ‚Ñ€Ğ¾Ğ½Ğ½Ğ¸ ĞºĞ°ÑĞ¾Ğ²Ğ¸ Ğ±ĞµĞ»ĞµĞ¶ĞºĞ¸** (Ñ„Ğ¸ÑĞºĞ°Ğ»Ğ½Ğ¸ Ğ±Ğ¾Ğ½Ğ¾Ğ²Ğµ) Ğ¿Ñ€Ğ¸ Ğ²ÑÑĞºĞ° Ğ¿Ğ»Ğ°Ñ‚ĞµĞ½Ğ° Ğ¿Ğ¾Ñ€ÑŠÑ‡ĞºĞ°.

### ĞÑĞ½Ğ¾Ğ²Ğ½Ğ¸ Ñ„ÑƒĞ½ĞºÑ†Ğ¸Ğ¸:

1. **ĞĞ²Ñ‚Ğ¾Ğ¼Ğ°Ñ‚Ğ¸Ñ‡Ğ½Ğ¾ Ğ¸Ğ·Ğ´Ğ°Ğ²Ğ°Ğ½Ğµ Ğ½Ğ° Ğ±ĞµĞ»ĞµĞ¶ĞºĞ¸** - Ğ¿Ñ€Ğ¸ Ğ²ÑÑĞºĞ¾ Ğ¿Ğ»Ğ°Ñ‰Ğ°Ğ½Ğµ Ñ‡Ñ€ĞµĞ· webhook Ğ¾Ñ‚ Wix
2. **Ğ¡Ñ‚Ğ¾Ñ€Ğ½Ğ¾ Ğ±ĞµĞ»ĞµĞ¶ĞºĞ¸** - Ğ¿Ñ€Ğ¸ Ğ²ÑŠĞ·ÑÑ‚Ğ°Ğ½Ğ¾Ğ²ÑĞ²Ğ°Ğ½Ğµ Ğ½Ğ° ÑÑƒĞ¼Ğ¸ (refund)
3. **Ğ”Ğ°Ğ½ÑŠÑ‡ĞµĞ½ Ğ¾Ğ´Ğ¸Ñ‚** - Ğ³ĞµĞ½ĞµÑ€Ğ¸Ñ€Ğ°Ğ½Ğµ Ğ½Ğ° XML Ñ„Ğ°Ğ¹Ğ»Ğ¾Ğ²Ğµ Ğ¿Ğ¾ ĞĞ°Ñ€ĞµĞ´Ğ±Ğ° Ğ-18, ĞŸÑ€Ğ¸Ğ»Ğ¾Ğ¶ĞµĞ½Ğ¸Ğµ 38
4. **Multi-tenant Ğ°Ñ€Ñ…Ğ¸Ñ‚ĞµĞºÑ‚ÑƒÑ€Ğ°** - Ğ¼Ğ½Ğ¾Ğ³Ğ¾ Ğ¼Ğ°Ğ³Ğ°Ğ·Ğ¸Ğ½Ğ¸, Ğ¼Ğ½Ğ¾Ğ³Ğ¾ Ğ¿Ğ¾Ñ‚Ñ€ĞµĞ±Ğ¸Ñ‚ĞµĞ»Ğ¸
5. **Subscription Ğ¼Ğ¾Ğ´ĞµĞ»** - Starter (50 Ğ¿Ğ¾Ñ€ÑŠÑ‡ĞºĞ¸), Business (300), Corporate (Ğ½ĞµĞ¾Ğ³Ñ€Ğ°Ğ½Ğ¸Ñ‡ĞµĞ½)

### Ğ¦ĞµĞ½Ğ¾Ğ¾Ğ±Ñ€Ğ°Ğ·ÑƒĞ²Ğ°Ğ½Ğµ:

| ĞŸĞ»Ğ°Ğ½ | Ğ›Ğ¸Ğ¼Ğ¸Ñ‚ | Ğ¦ĞµĞ½Ğ° | ĞĞ°Ğ´ Ğ»Ğ¸Ğ¼Ğ¸Ñ‚Ğ° |
|------|-------|------|------------|
| Starter | 50 Ğ¿Ğ¾Ñ€ÑŠÑ‡ĞºĞ¸/Ğ¼ĞµÑĞµÑ† | 5 EUR/Ğ¼ĞµÑĞµÑ† | +0.10 EUR/Ğ¿Ğ¾Ñ€ÑŠÑ‡ĞºĞ° |
| Business | 300 Ğ¿Ğ¾Ñ€ÑŠÑ‡ĞºĞ¸/Ğ¼ĞµÑĞµÑ† | 15 EUR/Ğ¼ĞµÑĞµÑ† | +0.10 EUR/Ğ¿Ğ¾Ñ€ÑŠÑ‡ĞºĞ° |
| Corporate | Ğ‘ĞµĞ· Ğ»Ğ¸Ğ¼Ğ¸Ñ‚ | 15 EUR + 0.10 EUR/Ğ¿Ğ¾Ñ€ÑŠÑ‡ĞºĞ° | N/A |

---

## 2. Ğ¢ĞµÑ…Ğ½Ğ¾Ğ»Ğ¾Ğ³Ğ¸Ñ‡ĞµĞ½ ÑÑ‚ĞµĞº

| ĞšĞ°Ñ‚ĞµĞ³Ğ¾Ñ€Ğ¸Ñ | Ğ¢ĞµÑ…Ğ½Ğ¾Ğ»Ğ¾Ğ³Ğ¸Ñ | Ğ’ĞµÑ€ÑĞ¸Ñ |
|-----------|------------|--------|
| Framework | Next.js (App Router) | 14.2.5 |
| Database | Vercel Postgres (Neon) | - |
| Auth | NextAuth.js | 4.24.13 |
| Frontend | React | 18.3.1 |
| PDF Generation | react-pdf, jsPDF, html2canvas | - |
| QR Code | qrcode | - |
| API Clients | Wix SDK, Stripe SDK | - |
| Hosting | Vercel | - |

### Environment Variables:

```bash
# Wix Integration
WIX_APP_ID
WIX_APP_SECRET
WIX_APP_PUBLIC_KEY
WIX_API_BASE (optional, defaults to https://www.wixapis.com)

# Database
POSTGRES_URL (Vercel Postgres)

# Auth
NEXTAUTH_SECRET
NEXTAUTH_URL

# Google OAuth
GOOGLE_CLIENT_ID
GOOGLE_CLIENT_SECRET

# Stripe
STRIPE_PUBLIC_KEY
STRIPE_SECRET_KEY
STRIPE_WEBHOOK_SECRET

# App Config
APP_BASE_URL (e.g., https://udito.vercel.app)
ADMIN_SECRET (for admin endpoints)
```

---

## 3. Ğ¡Ñ‚Ñ€ÑƒĞºÑ‚ÑƒÑ€Ğ° Ğ½Ğ° Ğ¿Ñ€Ğ¾ĞµĞºÑ‚Ğ°

```
/Users/mac/udito-app/
â”œâ”€â”€ app/                    # Next.js app directory
â”‚   â”œâ”€â”€ api/               # 99 API routes organized by feature
â”‚   â”‚   â”œâ”€â”€ auth/          # Authentication endpoints
â”‚   â”‚   â”œâ”€â”€ oauth/         # Wix OAuth flow
â”‚   â”‚   â”œâ”€â”€ orders/        # Order management
â”‚   â”‚   â”œâ”€â”€ receipts/      # Receipt operations
â”‚   â”‚   â”œâ”€â”€ stores/        # Store management
â”‚   â”‚   â”œâ”€â”€ sync/          # Order sync
â”‚   â”‚   â”œâ”€â”€ webhooks/      # Wix webhooks
â”‚   â”‚   â”œâ”€â”€ admin/         # Admin endpoints (31)
â”‚   â”‚   â”œâ”€â”€ debug/         # Debug endpoints (27)
â”‚   â”‚   â”œâ”€â”€ onboarding/    # Onboarding flow
â”‚   â”‚   â”œâ”€â”€ stripe/        # Stripe integration
â”‚   â”‚   â””â”€â”€ ...
â”‚   â”œâ”€â”€ components/        # 13 reusable React components
â”‚   â”œâ”€â”€ overview/          # Dashboard
â”‚   â”œâ”€â”€ orders/            # Order management pages
â”‚   â”œâ”€â”€ receipts/          # Receipt management pages
â”‚   â”œâ”€â”€ settings/          # Store settings
â”‚   â”œâ”€â”€ onboarding/        # User onboarding flow
â”‚   â”œâ”€â”€ billing/           # Billing & subscription
â”‚   â”œâ”€â”€ audit/             # Tax audit files
â”‚   â”œâ”€â”€ layout.tsx         # Root layout
â”‚   â””â”€â”€ page.tsx           # Landing page
â”œâ”€â”€ lib/                   # Core business logic (15 modules)
â”‚   â”œâ”€â”€ db.ts              # Database operations (55 KB)
â”‚   â”œâ”€â”€ auth.ts            # Authentication (13 KB)
â”‚   â”œâ”€â”€ wix.ts             # Wix SDK integration (41 KB)
â”‚   â”œâ”€â”€ sync.ts            # Order synchronization (9.7 KB)
â”‚   â”œâ”€â”€ receipts.ts        # Receipt management (11.5 KB)
â”‚   â”œâ”€â”€ receipt-pdf.tsx    # PDF generation (51 KB)
â”‚   â”œâ”€â”€ auditXml.ts        # Tax audit XML (8.8 KB)
â”‚   â”œâ”€â”€ stripe.ts          # Stripe helpers
â”‚   â”œâ”€â”€ wix-context.ts     # Wix context handling
â”‚   â””â”€â”€ ...
â”œâ”€â”€ hooks/                 # React custom hooks (2)
â”œâ”€â”€ types/                 # TypeScript definitions
â”œâ”€â”€ public/                # Static assets
â”œâ”€â”€ middleware.ts          # Next.js middleware
â”œâ”€â”€ package.json           # Dependencies
â”œâ”€â”€ tsconfig.json          # TypeScript config
â””â”€â”€ vercel.json            # Vercel deployment config
```

### Ğ¡Ñ‚Ğ°Ñ‚Ğ¸ÑÑ‚Ğ¸ĞºĞ¸:

| ĞšĞ°Ñ‚ĞµĞ³Ğ¾Ñ€Ğ¸Ñ | Ğ‘Ñ€Ğ¾Ğ¹ |
|-----------|------|
| API Routes | 99 |
| Components | 13 |
| Library Modules | 15 |
| Pages | 25+ |
| Database Tables | 18 |

---

## 4. Ğ‘Ğ°Ğ·Ğ° Ğ´Ğ°Ğ½Ğ½Ğ¸

### ĞÑĞ½Ğ¾Ğ²Ğ½Ğ¸ Ñ‚Ğ°Ğ±Ğ»Ğ¸Ñ†Ğ¸:

#### orders
```sql
CREATE TABLE orders (
  id text PRIMARY KEY,
  business_id text,
  site_id text,
  number text,
  status text,
  payment_status text,
  created_at timestamptz,
  updated_at timestamptz,
  paid_at timestamptz,
  currency text,
  subtotal numeric,
  tax_total numeric,
  shipping_total numeric,
  discount_total numeric,
  total numeric,
  customer_email text,
  customer_name text,
  source text,
  raw jsonb
);
```

#### receipts
```sql
CREATE TABLE receipts (
  id bigserial PRIMARY KEY,
  order_id text NOT NULL,
  business_id text,
  issued_at timestamptz DEFAULT now(),
  status text DEFAULT 'issued',
  payload jsonb,
  type text DEFAULT 'sale',  -- 'sale' or 'refund'
  reference_receipt_id bigint,
  refund_amount numeric,
  return_payment_type text
);
```

#### companies
```sql
CREATE TABLE companies (
  site_id text PRIMARY KEY,
  business_id text UNIQUE,
  instance_id text UNIQUE,
  store_name text,
  legal_name text,
  vat_number text,
  bulstat text,
  address text,
  city text,
  phone text,
  email text,
  iban text,
  bank_name text,
  mol text,
  logo_url text,
  store_id text,  -- Fiscal device ID
  receipt_number_start integer,
  receipts_start_date timestamptz,
  cod_receipts_enabled boolean DEFAULT false,
  receipt_template jsonb,
  created_at timestamptz DEFAULT now(),
  updated_at timestamptz DEFAULT now()
);
```

#### wix_tokens
```sql
CREATE TABLE wix_tokens (
  id bigserial PRIMARY KEY,
  business_id text,
  site_id text,
  instance_id text,
  access_token text,
  refresh_token text,
  expires_at timestamptz,
  created_at timestamptz DEFAULT now(),
  updated_at timestamptz DEFAULT now()
);
```

#### store_connections
```sql
CREATE TABLE store_connections (
  id bigserial PRIMARY KEY,
  business_id text,
  site_id text,
  instance_id text,
  user_id text NOT NULL,
  role text DEFAULT 'member',  -- owner, admin, member, accountant
  access_code text,
  expires_at timestamptz,
  invited_by text,
  invited_at timestamptz,
  connected_at timestamptz DEFAULT now(),
  UNIQUE(site_id, user_id),
  UNIQUE(instance_id, user_id)
);
```

#### businesses
```sql
CREATE TABLE businesses (
  id text PRIMARY KEY DEFAULT gen_random_uuid(),
  name text,
  trial_ends_at timestamptz,
  subscription_status text DEFAULT 'trialing',
  plan_id text,
  stripe_customer_id text,
  stripe_subscription_id text,
  onboarding_completed boolean DEFAULT false,
  onboarding_step integer DEFAULT 0,
  selected_plan_id text,
  created_at timestamptz DEFAULT now(),
  updated_at timestamptz DEFAULT now()
);
```

#### monthly_usage
```sql
CREATE TABLE monthly_usage (
  id bigserial PRIMARY KEY,
  business_id text NOT NULL,
  year_month text NOT NULL,  -- '2026-01'
  orders_count integer DEFAULT 0,
  receipts_count integer DEFAULT 0,
  updated_at timestamptz DEFAULT now(),
  UNIQUE(business_id, year_month)
);
```

#### webhook_logs
```sql
CREATE TABLE webhook_logs (
  id bigserial PRIMARY KEY,
  event_type text,
  order_id text,
  order_number text,
  site_id text,
  instance_id text,
  status text,  -- 'received', 'processed', 'error'
  error_message text,
  payload_preview text,
  created_at timestamptz DEFAULT now()
);
```

### Ğ”Ğ¾Ğ¿ÑŠĞ»Ğ½Ğ¸Ñ‚ĞµĞ»Ğ½Ğ¸ Ñ‚Ğ°Ğ±Ğ»Ğ¸Ñ†Ğ¸:

| Ğ¢Ğ°Ğ±Ğ»Ğ¸Ñ†Ğ° | ĞĞ¿Ğ¸ÑĞ°Ğ½Ğ¸Ğµ |
|---------|----------|
| users | NextAuth Ğ¿Ğ¾Ñ‚Ñ€ĞµĞ±Ğ¸Ñ‚ĞµĞ»Ğ¸ |
| accounts | OAuth provider Ğ²Ñ€ÑŠĞ·ĞºĞ¸ |
| sessions | Active sessions |
| verification_tokens | Email verification |
| business_profiles | Business profile Ğ´Ğ°Ğ½Ğ½Ğ¸ |
| business_users | User access to businesses |
| subscription_plans | Available plans |
| billing_companies | Invoice billing info |
| access_codes | Shareable store access codes |
| sync_state | Order sync progress/cursor |

---

## 5. API Endpoints

### Authentication & OAuth (6 routes)
- `POST /api/auth/register` - User registration
- `POST /api/auth/check-email` - Verify email availability
- `POST /api/auth/link-store` - Connect store to user account
- `POST /api/auth/check-wix-store` - Validate Wix store
- `GET/POST /api/auth/[...nextauth]` - NextAuth endpoints
- `POST /api/oauth/callback` - OAuth callback handler

### Store Management (8 routes)
- `POST /api/stores/connect` - Connect a Wix store
- `POST /api/stores/join` - Join store with access code
- `DELETE /api/stores/delete` - Disconnect store
- `GET /api/stores/access-code` - List stores' access codes
- `POST /api/stores/users` - Manage store users
- `PUT /api/stores/update` - Update store settings
- `GET /api/sites` - List user's sites
- `POST /api/site/select` - Select active site

### Receipts (5 routes)
- `POST /api/receipts/cancel` - Cancel/delete a receipt
- `GET/POST /api/receipts/settings` - Get/update receipt settings
- `PUT /api/receipts/return-type` - Update refund payment type
- `GET/POST /api/receipts/appearance` - Customize receipt appearance

### Orders & Sync (8 routes)
- `GET /api/orders/list` - List orders
- `POST /api/sync/initial` - Initial order sync
- `POST /api/sync/auto` - Auto-sync orders
- `GET /api/sync/cron` - Cron job trigger
- `POST /api/backfill` - Backfill historical orders
- `POST /api/backfill/fast` - Fast backfill

### Webhooks (1 route)
- `POST /api/webhooks/wix/orders` - Wix order webhook handler

### Reports & Auditing (2 routes)
- `GET /api/audit/monthly` - Generate audit XML for month
- `GET /api/reports/monthly` - Monthly report

### Onboarding (5 routes)
- `POST /api/onboarding/company` - Save company profile
- `POST /api/onboarding/plan` - Select subscription plan
- `POST /api/onboarding/settings` - Save onboarding settings
- `POST /api/onboarding/complete` - Mark onboarding complete
- `GET /api/onboarding/status` - Get current status

### Billing & Stripe (4 routes)
- `POST /api/stripe/setup-intent` - Create Stripe setup intent
- `POST /api/stripe/verify-card` - Verify card
- `GET /api/subscription/status` - Get subscription status

### Admin Endpoints (31 routes)
- `/api/admin/init-db` - Initialize database
- `/api/admin/seed-demo` - Seed demo data
- `/api/admin/backfill` - Backfill orders
- `/api/admin/sync-order` - Sync specific order
- `/api/admin/enrich-orders` - Enrich order data
- `/api/admin/fix-*` - Various data fixes
- `/api/admin/webhook-logs` - View webhook logs
- etc.

### Debug Endpoints (27 routes)
- `/api/debug/order` - Inspect order
- `/api/debug/payment` - Inspect payment
- `/api/debug/receipt-check` - Check receipt status
- etc.

---

## 6. ĞšĞ°Ğº Ñ€Ğ°Ğ±Ğ¾Ñ‚Ğ¸ Ğ¿Ñ€Ğ¸Ğ»Ğ¾Ğ¶ĞµĞ½Ğ¸ĞµÑ‚Ğ¾

### 6.1 ĞŸĞ¾Ñ‚Ğ¾Ğº Ğ½Ğ° Ğ½Ğ¾Ğ²Ğ° Ğ¿Ğ¾Ñ€ÑŠÑ‡ĞºĞ° (Webhook)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   ĞšĞ»Ğ¸ĞµĞ½Ñ‚ Ğ¿Ñ€Ğ°Ğ²Ğ¸  â”‚
â”‚    Ğ¿Ğ¾Ñ€ÑŠÑ‡ĞºĞ°      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Wix Ğ¸Ğ·Ğ¿Ñ€Ğ°Ñ‰Ğ°    â”‚â”€â”€â”€â”€â”€â–ºâ”‚  /api/webhooks/ â”‚
â”‚  webhook (JWS)  â”‚      â”‚  wix/orders     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                  â”‚
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚                        â”‚                        â”‚
         â–¼                        â–¼                        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. Decode JWS   â”‚    â”‚ 2. Ğ—Ğ°Ğ¿Ğ¸Ñ Ğ²      â”‚    â”‚ 3. ĞĞºĞ¾ PAID:    â”‚
â”‚    token        â”‚    â”‚    orders       â”‚    â”‚    issueReceipt â”‚
â”‚    Ğ¸Ğ·Ğ²Ğ»Ğ¸Ñ‡Ğ°Ğ½Ğµ    â”‚    â”‚    Ñ‚Ğ°Ğ±Ğ»Ğ¸Ñ†Ğ°      â”‚    â”‚                 â”‚
â”‚    siteId       â”‚    â”‚                 â”‚    â”‚                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 6.2 Ğ”ĞµÑ‚Ğ°Ğ¹Ğ»Ğ¸ Ğ½Ğ° webhook Ğ¾Ğ±Ñ€Ğ°Ğ±Ğ¾Ñ‚ĞºĞ°Ñ‚Ğ°

1. **ĞŸĞ¾Ğ»ÑƒÑ‡Ğ°Ğ²Ğ°Ğ½Ğµ Ğ½Ğ° webhook** (`POST /api/webhooks/wix/orders`)
   - Wix Ğ¸Ğ·Ğ¿Ñ€Ğ°Ñ‰Ğ° JWS (JSON Web Signature) token
   - Body format: `header.payload.signature`

2. **Ğ”ĞµĞºĞ¾Ğ´Ğ¸Ñ€Ğ°Ğ½Ğµ Ğ½Ğ° JWS**
   - Ğ˜Ğ·Ğ²Ğ»Ğ¸Ñ‡Ğ°Ğ½Ğµ Ğ½Ğ° base64 payload
   - ĞŸĞ°Ñ€ÑĞ²Ğ°Ğ½Ğµ Ğ½Ğ° JSON Ğ´Ğ°Ğ½Ğ½Ğ¸Ñ‚Ğµ
   - Ğ˜Ğ·Ğ²Ğ»Ğ¸Ñ‡Ğ°Ğ½Ğµ Ğ½Ğ° `instanceId` Ğ¾Ñ‚ Ğ²Ğ»Ğ¾Ğ¶ĞµĞ½Ğ¸Ñ `instance` JWT token

3. **Ğ˜Ğ´ĞµĞ½Ñ‚Ğ¸Ñ„Ğ¸ĞºĞ°Ñ†Ğ¸Ñ Ğ½Ğ° Ğ¼Ğ°Ğ³Ğ°Ğ·Ğ¸Ğ½Ğ°**
   - ĞŸÑ€Ğ¸Ğ¾Ñ€Ğ¸Ñ‚ĞµÑ‚ 1: URL Ğ¿Ğ°Ñ€Ğ°Ğ¼ĞµÑ‚Ñ€Ğ¸ (`?instanceId=...&siteId=...`)
   - ĞŸÑ€Ğ¸Ğ¾Ñ€Ğ¸Ñ‚ĞµÑ‚ 2: HTTP headers (`x-wix-instance`)
   - ĞŸÑ€Ğ¸Ğ¾Ñ€Ğ¸Ñ‚ĞµÑ‚ 3: JWS payload
   - Fallback: Ğ¢ÑŠÑ€ÑĞµĞ½Ğµ Ğ² companies Ñ‚Ğ°Ğ±Ğ»Ğ¸Ñ†Ğ°Ñ‚Ğ° Ğ¿Ğ¾ instanceId

4. **Ğ—Ğ°Ğ¿Ğ¸Ñ Ğ½Ğ° Ğ¿Ğ¾Ñ€ÑŠÑ‡ĞºĞ°Ñ‚Ğ°**
   - UPSERT Ğ² orders Ñ‚Ğ°Ğ±Ğ»Ğ¸Ñ†Ğ°Ñ‚Ğ°
   - ĞĞ±Ğ¾Ğ³Ğ°Ñ‚ÑĞ²Ğ°Ğ½Ğµ Ñ payment Ğ´Ğ°Ğ½Ğ½Ğ¸ Ğ¾Ñ‚ Wix API
   - Ğ˜Ğ·Ğ²Ğ»Ğ¸Ñ‡Ğ°Ğ½Ğµ Ğ½Ğ° transaction ref

5. **Ğ˜Ğ·Ğ´Ğ°Ğ²Ğ°Ğ½Ğµ Ğ½Ğ° Ğ±ĞµĞ»ĞµĞ¶ĞºĞ°** (Ğ°ĞºĞ¾ Ğ¿Ğ¾Ñ€ÑŠÑ‡ĞºĞ°Ñ‚Ğ° Ğµ Ğ¿Ğ»Ğ°Ñ‚ĞµĞ½Ğ°)
   - ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° Ğ·Ğ° receipts_start_date
   - ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° Ğ·Ğ° fiscal store_id
   - ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° Ğ·Ğ° transaction ref
   - Ğ“ĞµĞ½ĞµÑ€Ğ¸Ñ€Ğ°Ğ½Ğµ Ğ½Ğ° receipt Ğ½Ğ¾Ğ¼ĞµÑ€
   - Ğ—Ğ°Ğ¿Ğ¸Ñ Ğ² receipts Ñ‚Ğ°Ğ±Ğ»Ğ¸Ñ†Ğ°Ñ‚Ğ°

### 6.3 Sync Ğ¼ĞµÑ…Ğ°Ğ½Ğ¸Ğ·ÑŠĞ¼

```
POST /api/sync/initial
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  syncOrdersForSite(siteId)          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  1. Get Wix access token            â”‚
â”‚  2. Query orders with cursor        â”‚
â”‚  3. Pre-fetch all site payments     â”‚
â”‚  4. For each order:                 â”‚
â”‚     - Check if needs enrichment     â”‚
â”‚     - Fetch full order details      â”‚
â”‚     - Extract delivery method       â”‚
â”‚     - Extract transaction ref       â”‚
â”‚     - Upsert to database            â”‚
â”‚     - Auto-issue receipt (if PAID   â”‚
â”‚       AND current month)            â”‚
â”‚  5. Update sync cursor              â”‚
â”‚  6. Repeat until no more pages      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 6.4 Receipt Ğ¸Ğ·Ğ´Ğ°Ğ²Ğ°Ğ½Ğµ

**Ğ£ÑĞ»Ğ¾Ğ²Ğ¸Ñ Ğ·Ğ° Ğ°Ğ²Ñ‚Ğ¾Ğ¼Ğ°Ñ‚Ğ¸Ñ‡Ğ½Ğ¾ Ğ¸Ğ·Ğ´Ğ°Ğ²Ğ°Ğ½Ğµ:**
1. `payment_status = 'PAID'`
2. `receipts_start_date` Ğµ ĞºĞ¾Ğ½Ñ„Ğ¸Ğ³ÑƒÑ€Ğ¸Ñ€Ğ°Ğ½
3. `paidAt >= receipts_start_date`
4. `store_id` (fiscal code) Ğµ Ğ½Ğ°Ğ»Ğ¸Ñ‡ĞµĞ½
5. `transaction_ref` Ğµ Ğ½Ğ°Ğ»Ğ¸Ñ‡ĞµĞ½
6. `total > 0`
7. (Ğ—Ğ° COD) `cod_receipts_enabled = true`
8. (Ğ—Ğ° sync) ĞŸĞ¾Ñ€ÑŠÑ‡ĞºĞ°Ñ‚Ğ° Ğµ Ğ¿Ğ»Ğ°Ñ‚ĞµĞ½Ğ° Ğ² Ñ‚ĞµĞºÑƒÑ‰Ğ¸Ñ Ğ¼ĞµÑĞµÑ†

**Receipt Ğ½Ğ¾Ğ¼ĞµÑ€Ğ°Ñ†Ğ¸Ñ:**
- `MAX(id) + 1` Ğ¾Ñ‚ receipts Ñ‚Ğ°Ğ±Ğ»Ğ¸Ñ†Ğ°Ñ‚Ğ°
- ĞŸĞ¾Ğ·Ğ²Ğ¾Ğ»ÑĞ²Ğ° Ğ¿Ğ¾Ğ²Ñ‚Ğ¾Ñ€Ğ½Ğ¾ Ğ¸Ğ·Ğ¿Ğ¾Ğ»Ğ·Ğ²Ğ°Ğ½Ğµ Ğ½Ğ° Ğ¸Ğ·Ñ‚Ñ€Ğ¸Ñ‚Ğ¸ Ğ½Ğ¾Ğ¼ĞµÑ€Ğ°

### 6.5 Refund (ÑÑ‚Ğ¾Ñ€Ğ½Ğ¾) Ğ±ĞµĞ»ĞµĞ¶ĞºĞ¸

1. Webhook Ğ¿Ğ¾Ğ»ÑƒÑ‡Ğ°Ğ²Ğ° `payment_status = 'REFUNDED'`
2. Ğ¢ÑŠÑ€ÑĞµĞ½Ğµ Ğ½Ğ° Ğ¾Ñ€Ğ¸Ğ³Ğ¸Ğ½Ğ°Ğ»Ğ½Ğ°Ñ‚Ğ° sale receipt
3. ĞĞºĞ¾ ÑÑŠÑ‰ĞµÑÑ‚Ğ²ÑƒĞ²Ğ° â†’ ÑÑŠĞ·Ğ´Ğ°Ğ²Ğ°Ğ½Ğµ Ğ½Ğ° refund receipt
4. Refund amount = Ğ¾Ñ‚Ñ€Ğ¸Ñ†Ğ°Ñ‚ĞµĞ»Ğ½Ğ° ÑÑ‚Ğ¾Ğ¹Ğ½Ğ¾ÑÑ‚
5. Reference ĞºÑŠĞ¼ Ğ¾Ñ€Ğ¸Ğ³Ğ¸Ğ½Ğ°Ğ»Ğ½Ğ°Ñ‚Ğ° Ğ±ĞµĞ»ĞµĞ¶ĞºĞ°

---

## 7. Multi-tenant Ğ°Ñ€Ñ…Ğ¸Ñ‚ĞµĞºÑ‚ÑƒÑ€Ğ°

### 7.1 Ğ¢Ñ€Ğ¸ Ğ½Ğ¸Ğ²Ğ° Ğ½Ğ° Ğ¸Ğ´ĞµĞ½Ñ‚Ğ¸Ñ„Ğ¸ĞºĞ°Ñ†Ğ¸Ñ

| Ğ˜Ğ´ĞµĞ½Ñ‚Ğ¸Ñ„Ğ¸ĞºĞ°Ñ‚Ğ¾Ñ€ | ĞšĞ°ĞºĞ²Ğ¾ Ğµ | Ğ˜Ğ·Ğ¿Ğ¾Ğ»Ğ·Ğ²Ğ° ÑĞµ Ğ·Ğ° |
|---------------|---------|----------------|
| `site_id` | Ğ£Ğ½Ğ¸ĞºĞ°Ğ»ĞµĞ½ ID Ğ½Ğ° Wix ÑĞ°Ğ¹Ñ‚Ğ° | ĞÑĞ½Ğ¾Ğ²ĞµĞ½ ĞºĞ»ÑÑ‡ Ğ·Ğ° Ñ„Ğ¸Ğ»Ñ‚Ñ€Ğ¸Ñ€Ğ°Ğ½Ğµ |
| `instance_id` | ID Ğ½Ğ° app Ğ¸Ğ½ÑÑ‚Ğ°Ğ»Ğ°Ñ†Ğ¸ÑÑ‚Ğ° | Wix OAuth, fallback |
| `business_id` | ID Ğ½Ğ° Ğ±Ğ¸Ğ·Ğ½ĞµÑĞ° Ğ² UDITO | Subscription, billing |

### 7.2 Ğ’Ñ€ÑŠĞ·ĞºĞ° Ğ¼ĞµĞ¶Ğ´Ñƒ entities

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        BUSINESSES                           â”‚
â”‚  (Ğ°Ğ±Ğ¾Ğ½Ğ°Ğ¼ĞµĞ½Ñ‚Ğ¸, billing, trial)                               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                             â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚   â”‚  Business 1 â”‚    â”‚  Business 2 â”‚    â”‚  Business 3 â”‚    â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚          â”‚                  â”‚                  â”‚            â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚   â”‚   Site A    â”‚    â”‚   Site B    â”‚    â”‚   Site C    â”‚    â”‚
â”‚   â”‚   (shop1)   â”‚    â”‚   (shop2)   â”‚    â”‚   Site D    â”‚    â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚          â”‚                                                  â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”‚
â”‚   â”‚             store_connections           â”‚              â”‚
â”‚   â”‚  user_1 â†’ Site A (owner)                â”‚              â”‚
â”‚   â”‚  user_2 â†’ Site A (accountant)           â”‚              â”‚
â”‚   â”‚  user_3 â†’ Site B (owner)                â”‚              â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 7.3 ĞĞ¿Ñ€ĞµĞ´ĞµĞ»ÑĞ½Ğµ Ğ½Ğ° Ğ°ĞºÑ‚Ğ¸Ğ²ĞµĞ½ Ğ¼Ğ°Ğ³Ğ°Ğ·Ğ¸Ğ½

**Ğ¤ÑƒĞ½ĞºÑ†Ğ¸Ñ: `getActiveStore()`**

3-ÑÑ‚ĞµĞ¿ĞµĞ½ĞµĞ½ Ğ¿Ñ€Ğ¸Ğ¾Ñ€Ğ¸Ñ‚ĞµÑ‚:
1. **URL Ğ¿Ğ°Ñ€Ğ°Ğ¼ĞµÑ‚Ñ€Ğ¸** (Ğ½Ğ°Ğ¹-Ğ²Ğ¸ÑĞ¾Ğº) - `?siteId=abc` Ğ¸Ğ»Ğ¸ `?instanceId=xyz`
2. **NextAuth ÑĞµÑĞ¸Ñ** - Ğ¾Ñ‚ `store_connections` Ñ‚Ğ°Ğ±Ğ»Ğ¸Ñ†Ğ°Ñ‚Ğ°
3. **Wix cookies** (Ğ½Ğ°Ğ¹-Ğ½Ğ¸ÑÑŠĞº) - `udito_instance_id`, `udito_site_id`

```typescript
export async function getActiveStore(options?: {
  searchParams?: URLSearchParams;
  cookies?: RequestCookies | ReadonlyRequestCookies;
  session?: Session | null;
}): Promise<ActiveStore | null> {
  // 1. Check URL params
  const urlSiteId = searchParams?.get('siteId');
  const urlInstanceId = searchParams?.get('instanceId');
  if (urlSiteId || urlInstanceId) {
    return { siteId: urlSiteId, instanceId: urlInstanceId };
  }

  // 2. Check NextAuth session
  if (session?.user?.id) {
    const stores = await getUserStores(session.user.id);
    if (stores.length > 0) {
      return stores[0];
    }
  }

  // 3. Check Wix cookies
  const cookieSiteId = cookies?.get('udito_site_id')?.value;
  const cookieInstanceId = cookies?.get('udito_instance_id')?.value;
  return { siteId: cookieSiteId, instanceId: cookieInstanceId };
}
```

### 7.4 Ğ¢ĞµĞºÑƒÑ‰Ğ¸ Ğ¼Ğ°Ğ³Ğ°Ğ·Ğ¸Ğ½Ğ¸ Ğ² ÑĞ¸ÑÑ‚ĞµĞ¼Ğ°Ñ‚Ğ°

```
ĞœĞ°Ğ³Ğ°Ğ·Ğ¸Ğ½ A (The White Rabbit Shop):
  - site_id: 6240f8a5-7af4-4fdf-96c1-d1f22b205408
  - instance_id: 8865cc09-0949-43c4-a09c-5fdfbb352edf
  - receipts_start_date: 2024-12-14
  - cod_receipts_enabled: true

ĞœĞ°Ğ³Ğ°Ğ·Ğ¸Ğ½ B (www.fst.bg):
  - site_id: de34f1c3-7bff-4501-9e04-bd90f3c43ae5
  - instance_id: fb0c3881-1957-4835-9f46-50862ef24379
  - receipts_start_date: NULL
  - cod_receipts_enabled: false
```

---

## 8. ĞĞ°Ğ¼ĞµÑ€ĞµĞ½Ğ¸ Ğ¿Ñ€Ğ¾Ğ±Ğ»ĞµĞ¼Ğ¸

### 8.1 ĞšĞ Ğ˜Ğ¢Ğ˜Ğ§ĞĞ˜ ĞŸĞ ĞĞ‘Ğ›Ğ•ĞœĞ˜ (Multi-tenancy data leaks)

| # | ĞŸÑ€Ğ¾Ğ±Ğ»ĞµĞ¼ | Ğ¤Ğ°Ğ¹Ğ»:Ğ ĞµĞ´ | ĞĞ¿Ğ¸ÑĞ°Ğ½Ğ¸Ğµ | Ğ’ÑŠĞ·Ğ´ĞµĞ¹ÑÑ‚Ğ²Ğ¸Ğµ |
|---|---------|----------|----------|-------------|
| 1 | `getNextReceiptId()` Ğ±ĞµĞ· site_id | receipts.ts:7-9 | `MAX(id)` Ğ¾Ñ‚ Ğ’Ğ¡Ğ˜Ğ§ĞšĞ˜ Ğ±ĞµĞ»ĞµĞ¶ĞºĞ¸ | ĞĞ¾Ğ¼ĞµÑ€Ğ°Ñ‚Ğ° ÑĞ° ÑĞ¿Ğ¾Ğ´ĞµĞ»ĞµĞ½Ğ¸ Ğ¼ĞµĞ¶Ğ´Ñƒ ĞºĞ»Ğ¸ĞµĞ½Ñ‚Ğ¸ |
| 2 | `listRecentReceipts()` Ğ±ĞµĞ· Ñ„Ğ¸Ğ»Ñ‚ÑŠÑ€ | receipts.ts:185-193 | ĞÑĞ¼Ğ° WHERE site_id | ĞŸĞ¾ĞºĞ°Ğ·Ğ²Ğ° Ğ±ĞµĞ»ĞµĞ¶ĞºĞ¸ Ğ¾Ñ‚ Ğ²ÑĞ¸Ñ‡ĞºĞ¸ Ğ¼Ğ°Ğ³Ğ°Ğ·Ğ¸Ğ½Ğ¸ |
| 3 | `listReceiptsForPeriod()` Ğ±ĞµĞ· Ñ„Ğ¸Ğ»Ñ‚ÑŠÑ€ | receipts.ts:195-203 | ĞÑĞ¼Ğ° WHERE site_id | Data leak Ğ² Ğ¾Ñ‚Ñ‡ĞµÑ‚Ğ¸Ñ‚Ğµ |
| 4 | `listReceiptsWithOrders()` Ğ±ĞµĞ· Ñ„Ğ¸Ğ»Ñ‚ÑŠÑ€ | receipts.ts:205-224 | Ğ¤Ğ¸Ğ»Ñ‚Ñ€Ğ¸Ñ€Ğ° ÑĞ°Ğ¼Ğ¾ Ğ¿Ğ¾ order status | Data leak |
| 5 | `listRecentOrders()` Ğ±ĞµĞ· Ñ„Ğ¸Ğ»Ñ‚ÑŠÑ€ | db.ts:765-773 | Ğ’Ñ€ÑŠÑ‰Ğ° Ğ¿Ğ¾Ñ€ÑŠÑ‡ĞºĞ¸ Ğ¾Ñ‚ Ğ²ÑĞ¸Ñ‡ĞºĞ¸ ÑĞ°Ğ¹Ñ‚Ğ¾Ğ²Ğµ | Data leak |
| 6 | `listDetailedOrders()` Ğ±ĞµĞ· Ñ„Ğ¸Ğ»Ñ‚ÑŠÑ€ | db.ts:927-946 | ĞŸÑŠĞ»Ğ½Ğ¸ Ğ´Ğ°Ğ½Ğ½Ğ¸ Ğ¾Ñ‚ Ğ²ÑĞ¸Ñ‡ĞºĞ¸ ÑĞ°Ğ¹Ñ‚Ğ¾Ğ²Ğµ | Data leak |
| 7 | `listAllDetailedOrders()` Ğ±ĞµĞ· Ñ„Ğ¸Ğ»Ñ‚ÑŠÑ€ | db.ts:995-1013 | Ğ’Ğ¡Ğ˜Ğ§ĞšĞ˜ Ğ¿Ğ¾Ñ€ÑŠÑ‡ĞºĞ¸ Ñ Ğ¸Ğ¼ĞµĞ½Ğ°/Ğ¸Ğ¼ĞµĞ¹Ğ»Ğ¸ | ĞšÑ€Ğ¸Ñ‚Ğ¸Ñ‡ĞµĞ½ data leak |
| 8 | Receipt cancel - null check | cancel/route.ts:52 | `!receiptSiteId` Ğ¿Ğ¾Ğ·Ğ²Ğ¾Ğ»ÑĞ²Ğ° Ğ´Ğ¾ÑÑ‚ÑŠĞ¿ | Unauthorized deletes |

### 8.2 ĞšĞ Ğ˜Ğ¢Ğ˜Ğ§ĞĞ˜ ĞŸĞ ĞĞ‘Ğ›Ğ•ĞœĞ˜ (Race conditions)

| # | ĞŸÑ€Ğ¾Ğ±Ğ»ĞµĞ¼ | Ğ¤Ğ°Ğ¹Ğ» | ĞĞ¿Ğ¸ÑĞ°Ğ½Ğ¸Ğµ | Ğ’ÑŠĞ·Ğ´ĞµĞ¹ÑÑ‚Ğ²Ğ¸Ğµ |
|---|---------|------|----------|-------------|
| 9 | Webhook vs Sync race | route.ts + sync.ts | ĞÑĞ¼Ğ° row-level locking | paidAt ÑĞµ Ğ¿Ñ€ĞµĞ·Ğ°Ğ¿Ğ¸ÑĞ²Ğ° |
| 10 | Duplicate receipt issuance | receipts.ts:24-50 | Check Ğ¸ INSERT Ğ½Ğµ ÑĞ° Ğ² transaction | 2 Ğ±ĞµĞ»ĞµĞ¶ĞºĞ¸ Ğ·Ğ° 1 Ğ¿Ğ¾Ñ€ÑŠÑ‡ĞºĞ° |
| 11 | Silent receipt failure | route.ts:551-559 | ĞÑĞ¼Ğ° return value Ğ¾Ñ‚ issueReceipt | ĞŸĞ»Ğ°Ğ½ Ğ»Ğ¸Ğ¼Ğ¸Ñ‚Ğ¸ ÑĞµ Ğ¸Ğ·Ñ€Ğ°Ğ·Ñ…Ğ¾Ğ´Ğ²Ğ°Ñ‚ Ğ±ĞµĞ· Ğ±ĞµĞ»ĞµĞ¶ĞºĞ° |
| 12 | paidAt timestamp race | route.ts:370-376,493-502 | Read-after-write race | Ğ“Ñ€ĞµÑˆĞµĞ½ timestamp Ğ² Ğ±ĞµĞ»ĞµĞ¶ĞºĞ° |

### 8.3 Ğ’Ğ˜Ğ¡ĞĞšĞ˜ ĞŸĞ ĞĞ‘Ğ›Ğ•ĞœĞ˜ (Webhook/Sync)

| # | ĞŸÑ€Ğ¾Ğ±Ğ»ĞµĞ¼ | Ğ¤Ğ°Ğ¹Ğ»:Ğ ĞµĞ´ | ĞĞ¿Ğ¸ÑĞ°Ğ½Ğ¸Ğµ | Ğ’ÑŠĞ·Ğ´ĞµĞ¹ÑÑ‚Ğ²Ğ¸Ğµ |
|---|---------|----------|----------|-------------|
| 13 | JWS base64 decode | route.ts:690 | ĞÑĞ¼Ğ° URL-safe decode | Webhook Ğ½Ğµ ÑĞµ Ğ¾Ğ±Ñ€Ğ°Ğ±Ğ¾Ñ‚Ğ²Ğ° |
| 14 | Triple-nested JSON | route.ts:715-724 | Assumptions Ğ·Ğ° ÑÑ‚Ñ€ÑƒĞºÑ‚ÑƒÑ€Ğ°Ñ‚Ğ° | Ğ“Ñ€ĞµÑˆĞ½Ğ¸ Ğ´Ğ°Ğ½Ğ½Ğ¸ |
| 15 | Sync cursor validation | sync.ts:263-265 | ĞÑĞ¼Ğ° Ğ²Ğ°Ğ»Ğ¸Ğ´Ğ°Ñ†Ğ¸Ñ | API waste |
| 16 | Sync error recovery | sync.ts:262-265 | ĞÑĞ¼Ğ° try-catch | Duplicate orders |
| 17 | Refund receipt lost | route.ts:575-606 | ĞĞºĞ¾ sale Ğ½Ğµ Ğµ Ğ¸Ğ·Ğ´Ğ°Ğ´ĞµĞ½Ğ° | ĞĞµĞ¿ÑŠĞ»ĞµĞ½ audit |
| 18 | No webhook idempotency | route.ts:628 | ĞÑĞ¼Ğ° event_id check | Duplicate processing |

### 8.4 Ğ¡Ğ Ğ•Ğ”ĞĞ˜ ĞŸĞ ĞĞ‘Ğ›Ğ•ĞœĞ˜

| # | ĞŸÑ€Ğ¾Ğ±Ğ»ĞµĞ¼ | Ğ¤Ğ°Ğ¹Ğ» | ĞĞ¿Ğ¸ÑĞ°Ğ½Ğ¸Ğµ | Ğ’ÑŠĞ·Ğ´ĞµĞ¹ÑÑ‚Ğ²Ğ¸Ğµ |
|---|---------|------|----------|-------------|
| 19 | siteId/instanceId mixing | orders/list:14-17 | OR fallback Ğ»Ğ¾Ğ³Ğ¸ĞºĞ° | ĞŸĞ¾Ñ‚ĞµĞ½Ñ†Ğ¸Ğ°Ğ»ĞµĞ½ data leak |
| 20 | OR logic Ğ² settings | receipts/settings | ĞœĞ¾Ğ¶Ğµ Ğ´Ğ° match-Ğ½Ğµ Ğ³Ñ€ĞµÑˆĞ½Ğ° company | Data corruption |
| 21 | Webhook fallback routing | route.ts:268-280 | 1 active company fallback | Ğ“Ñ€ĞµÑˆĞµĞ½ Ğ¼Ğ°Ğ³Ğ°Ğ·Ğ¸Ğ½ |
| 22 | Usage tracking OR logic | db.ts:1944-1968 | getBusinessIdFromStore OR | Ğ“Ñ€ĞµÑˆĞµĞ½ billing |

---

## 9. ĞŸĞ»Ğ°Ğ½ Ğ·Ğ° Ñ€ĞµÑˆĞ°Ğ²Ğ°Ğ½Ğµ

### Ğ¤Ğ°Ğ·Ğ° 1: ĞšĞ Ğ˜Ğ¢Ğ˜Ğ§ĞĞ˜ ĞŸĞĞŸĞ ĞĞ’ĞšĞ˜ (Ğ²ĞµĞ´Ğ½Ğ°Ğ³Ğ°)

#### 1.1 Ğ”Ğ¾Ğ±Ğ°Ğ²ÑĞ½Ğµ Ğ½Ğ° site_id ĞºÑŠĞ¼ receipts Ñ‚Ğ°Ğ±Ğ»Ğ¸Ñ†Ğ°Ñ‚Ğ°

```sql
-- Migration
ALTER TABLE receipts ADD COLUMN site_id text;

-- Backfill
UPDATE receipts
SET site_id = (
  SELECT site_id FROM orders WHERE orders.id = receipts.order_id
);

-- Index
CREATE INDEX idx_receipts_site_id ON receipts(site_id);
```

#### 1.2 ĞŸĞ¾Ğ¿Ñ€Ğ°Ğ²ÑĞ½Ğµ Ğ½Ğ° getNextReceiptId()

```typescript
// ĞŸĞ Ğ•Ğ”Ğ˜ (Ğ“Ğ Ğ•Ğ¨ĞĞ)
async function getNextReceiptId(): Promise<number> {
  const result = await sql`
    SELECT COALESCE(MAX(id), 0) + 1 as next_id FROM receipts
  `;
  return result.rows[0].next_id;
}

// Ğ¡Ğ›Ğ•Ğ” (ĞŸĞ ĞĞ’Ğ˜Ğ›ĞĞ)
async function getNextReceiptId(siteId: string): Promise<number> {
  const result = await sql`
    SELECT COALESCE(MAX(id), 0) + 1 as next_id
    FROM receipts
    WHERE site_id = ${siteId}
  `;
  return result.rows[0].next_id;
}
```

#### 1.3 ĞŸÑ€ĞµĞ¼Ğ°Ñ…Ğ²Ğ°Ğ½Ğµ/Ğ¿Ğ¾Ğ¿Ñ€Ğ°Ğ²ÑĞ½Ğµ Ğ½Ğ° data leak Ñ„ÑƒĞ½ĞºÑ†Ğ¸Ğ¸

**Ğ’Ğ°Ñ€Ğ¸Ğ°Ğ½Ñ‚ A: Ğ˜Ğ·Ñ‚Ñ€Ğ¸Ğ²Ğ°Ğ½Ğµ**
```typescript
// Ğ˜Ğ·Ñ‚Ñ€Ğ¸Ğ²Ğ°Ğ½Ğµ Ğ½Ğ°:
// - listRecentReceipts()
// - listReceiptsForPeriod()
// - listReceiptsWithOrders()
// - listRecentOrders()
// - listDetailedOrders()
// - listAllDetailedOrders()
```

**Ğ’Ğ°Ñ€Ğ¸Ğ°Ğ½Ñ‚ B: Ğ”Ğ¾Ğ±Ğ°Ğ²ÑĞ½Ğµ Ğ½Ğ° Ğ·Ğ°Ğ´ÑŠĞ»Ğ¶Ğ¸Ñ‚ĞµĞ»ĞµĞ½ siteId**
```typescript
// Ğ”Ğ¾Ğ±Ğ°Ğ²ÑĞ½Ğµ Ğ½Ğ° siteId Ğ¿Ğ°Ñ€Ğ°Ğ¼ĞµÑ‚ÑŠÑ€:
async function listRecentReceipts(siteId: string, limit = 20) {
  return await sql`
    SELECT ... FROM receipts
    WHERE site_id = ${siteId}
    ORDER BY issued_at DESC
    LIMIT ${limit}
  `;
}
```

#### 1.4 Fix receipt cancel auth

```typescript
// ĞŸĞ Ğ•Ğ”Ğ˜ (Ğ“Ğ Ğ•Ğ¨ĞĞ)
const isOwner = !receiptSiteId ||  // <-- ĞŸÑ€Ğ¾Ğ±Ğ»ĞµĞ¼!
                receiptSiteId === store.siteId ||
                receiptSiteId === store.instanceId;

// Ğ¡Ğ›Ğ•Ğ” (ĞŸĞ ĞĞ’Ğ˜Ğ›ĞĞ)
const isOwner = receiptSiteId === store.siteId ||
                receiptSiteId === store.instanceId;
```

### Ğ¤Ğ°Ğ·Ğ° 2: RACE CONDITIONS (Ñ‚Ğ°Ğ·Ğ¸ ÑĞµĞ´Ğ¼Ğ¸Ñ†Ğ°)

#### 2.1 Transaction Ğ·Ğ° receipt issuance

```typescript
export async function issueReceipt(params: IssueReceiptParams): Promise<{
  created: boolean;
  receiptId: number | null;
  error?: string;
}> {
  return await sql.begin(async (tx) => {
    // Check for existing receipt WITH LOCK
    const existing = await tx`
      SELECT id FROM receipts
      WHERE order_id = ${params.orderId} AND type = 'sale'
      FOR UPDATE
    `;

    if (existing.rows.length > 0) {
      return { created: false, receiptId: existing.rows[0].id };
    }

    // Get next ID for this site
    const nextId = await tx`
      SELECT COALESCE(MAX(id), 0) + 1 as next_id
      FROM receipts
      WHERE site_id = ${params.siteId}
      FOR UPDATE
    `;

    // Insert new receipt
    const result = await tx`
      INSERT INTO receipts (id, order_id, site_id, payload, type)
      VALUES (${nextId.rows[0].next_id}, ${params.orderId}, ${params.siteId}, ${params.payload}, 'sale')
      RETURNING id
    `;

    return { created: true, receiptId: result.rows[0].id };
  });
}
```

#### 2.2 Webhook idempotency

```typescript
// Ğ’ webhook handler:
const eventId = parsedPayload?.eventId ?? `${orderId}-${eventType}-${Date.now()}`;

const exists = await sql`
  SELECT id FROM webhook_logs
  WHERE event_id = ${eventId}
  LIMIT 1
`;

if (exists.rows.length > 0) {
  console.log('Duplicate webhook, skipping:', eventId);
  return NextResponse.json({ ok: true, duplicate: true });
}

// Log with event_id
await logWebhook({
  eventId,
  eventType,
  orderId,
  // ...
});
```

#### 2.3 Sync vs Webhook coordination

```typescript
// Ğ”Ğ¾Ğ±Ğ°Ğ²ÑĞ½Ğµ Ğ½Ğ° source_timestamp Ğ¿Ğ¾Ğ»Ğµ
ALTER TABLE orders ADD COLUMN source_timestamp timestamptz;

// ĞŸÑ€Ğ¸ UPSERT: Ğ·Ğ°Ğ¿Ğ°Ğ·Ğ²Ğ°Ğ½Ğµ Ğ½Ğ° Ğ¿Ğ¾-Ğ½Ğ¾Ğ²Ğ¸Ñ timestamp
await sql`
  INSERT INTO orders (id, paid_at, source_timestamp, ...)
  VALUES (${id}, ${paidAt}, ${sourceTimestamp}, ...)
  ON CONFLICT (id) DO UPDATE SET
    paid_at = CASE
      WHEN excluded.source_timestamp > orders.source_timestamp
      THEN excluded.paid_at
      ELSE orders.paid_at
    END,
    source_timestamp = GREATEST(excluded.source_timestamp, orders.source_timestamp),
    ...
`;
```

### Ğ¤Ğ°Ğ·Ğ° 3: ĞŸĞĞ”ĞĞ‘Ğ Ğ•ĞĞ˜Ğ¯ (ÑĞ»ĞµĞ´Ğ²Ğ°Ñ‰Ğ°Ñ‚Ğ° ÑĞµĞ´Ğ¼Ğ¸Ñ†Ğ°)

#### 3.1 ĞŸĞ¾Ğ´Ğ¾Ğ±Ñ€ÑĞ²Ğ°Ğ½Ğµ Ğ½Ğ° webhook site identification

```typescript
// Ğ’ POST handler:
if (!urlSiteId && !urlInstanceId && !headerSiteId && !headerInstanceId) {
  console.error('Webhook missing site context');
  await logWebhook({
    eventType: 'unknown',
    status: 'error',
    errorMessage: 'Missing site context',
  });
  return NextResponse.json({
    ok: false,
    error: 'Missing site context in webhook'
  }, { status: 400 });
}
```

#### 3.2 Sync error recovery

```typescript
export async function syncOrdersForSite(siteId: string, options?: SyncOptions) {
  let cursor = null;
  let pages = 0;
  const maxPages = options?.maxPages ?? 100;

  try {
    do {
      cursor = await runPage(cursor);
      pages += 1;

      // Save progress after each page
      await upsertSyncState({
        siteId,
        cursor,
        status: cursor ? 'partial' : 'done',
        lastError: null,
      });
    } while (cursor && pages < maxPages);

    return { success: true, pages };
  } catch (error) {
    // Save error state
    await upsertSyncState({
      siteId,
      cursor,
      status: 'error',
      lastError: (error as Error).message,
    });

    throw error;
  }
}
```

#### 3.3 Refund receipt queue

```sql
-- ĞĞ¾Ğ²Ğ° Ñ‚Ğ°Ğ±Ğ»Ğ¸Ñ†Ğ°
CREATE TABLE pending_refunds (
  id bigserial PRIMARY KEY,
  order_id text NOT NULL UNIQUE,
  created_at timestamptz DEFAULT now(),
  attempts integer DEFAULT 0,
  last_attempt timestamptz,
  last_error text
);
```

```typescript
// Ğ’ webhook handler:
if (isRefunded && !originalReceipt) {
  // Queue for later processing
  await sql`
    INSERT INTO pending_refunds (order_id)
    VALUES (${orderId})
    ON CONFLICT (order_id) DO NOTHING
  `;
  console.log('Refund queued for order:', orderId);
}

// Cron job Ğ·Ğ° Ğ¾Ğ±Ñ€Ğ°Ğ±Ğ¾Ñ‚ĞºĞ° Ğ½Ğ° pending refunds
export async function processPendingRefunds() {
  const pending = await sql`
    SELECT order_id FROM pending_refunds
    WHERE attempts < 5
    AND (last_attempt IS NULL OR last_attempt < NOW() - INTERVAL '1 hour')
    LIMIT 10
  `;

  for (const { order_id } of pending.rows) {
    const originalReceipt = await getSaleReceiptByOrderId(order_id);
    if (originalReceipt) {
      await issueRefundReceipt({ orderId: order_id, ... });
      await sql`DELETE FROM pending_refunds WHERE order_id = ${order_id}`;
    } else {
      await sql`
        UPDATE pending_refunds
        SET attempts = attempts + 1, last_attempt = NOW()
        WHERE order_id = ${order_id}
      `;
    }
  }
}
```

### Ğ¤Ğ°Ğ·Ğ° 4: CLEANUP (ongoing)

- ĞŸÑ€ĞµĞ¼Ğ°Ñ…Ğ²Ğ°Ğ½Ğµ Ğ½Ğ° debug endpoints Ğ² production
- Ğ”Ğ¾Ğ±Ğ°Ğ²ÑĞ½Ğµ Ğ½Ğ° audit logging Ğ·Ğ° sensitive Ğ¾Ğ¿ĞµÑ€Ğ°Ñ†Ğ¸Ğ¸
- Rate limiting Ğ·Ğ° API endpoints
- Ğ”Ğ¾ĞºÑƒĞ¼ĞµĞ½Ñ‚Ğ°Ñ†Ğ¸Ñ Ğ½Ğ° API endpoints

---

## 10. ĞŸÑ€Ğ¸Ğ¾Ñ€Ğ¸Ñ‚Ğ¸Ğ·Ğ¸Ñ€Ğ°Ğ½ ÑĞ¿Ğ¸ÑÑŠĞº Ğ½Ğ° Ğ·Ğ°Ğ´Ğ°Ñ‡Ğ¸

| ĞŸÑ€Ğ¸Ğ¾Ñ€Ğ¸Ñ‚ĞµÑ‚ | Ğ—Ğ°Ğ´Ğ°Ñ‡Ğ° | Ğ¤Ğ°Ğ¹Ğ» | Ğ¡Ğ»Ğ¾Ğ¶Ğ½Ğ¾ÑÑ‚ | Ğ Ğ¸ÑĞº Ğ°ĞºĞ¾ ĞĞ• ÑĞµ Ğ½Ğ°Ğ¿Ñ€Ğ°Ğ²Ğ¸ |
|-----------|--------|------|----------|------------------------|
| ğŸ”´ P0 | Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ¸ site_id ĞºÑŠĞ¼ receipts | lib/db.ts, lib/receipts.ts | Medium | Data leak Ğ¼ĞµĞ¶Ğ´Ñƒ ĞºĞ»Ğ¸ĞµĞ½Ñ‚Ğ¸ |
| ğŸ”´ P0 | ĞŸĞ¾Ğ¿Ñ€Ğ°Ğ²Ğ¸ getNextReceiptId() | lib/receipts.ts | Easy | Ğ“Ñ€ĞµÑˆĞ½Ğ¸ Ğ½Ğ¾Ğ¼ĞµÑ€Ğ° Ğ½Ğ° Ğ±ĞµĞ»ĞµĞ¶ĞºĞ¸ |
| ğŸ”´ P0 | ĞŸÑ€ĞµĞ¼Ğ°Ñ…Ğ½Ğ¸/Ğ¿Ğ¾Ğ¿Ñ€Ğ°Ğ²Ğ¸ data leak Ñ„ÑƒĞ½ĞºÑ†Ğ¸Ğ¸ | lib/db.ts, lib/receipts.ts | Easy | Data leak |
| ğŸ”´ P0 | Fix receipt cancel null check | api/receipts/cancel | Easy | Unauthorized deletes |
| ğŸŸ  P1 | Transaction Ğ·Ğ° receipt issuance | lib/receipts.ts | Medium | Duplicate receipts |
| ğŸŸ  P1 | Webhook idempotency | api/webhooks | Medium | Duplicate processing |
| ğŸŸ  P1 | Sync error recovery | lib/sync.ts | Medium | Lost/duplicate data |
| ğŸŸ  P1 | Fix paidAt race condition | api/webhooks, lib/sync.ts | Medium | Wrong timestamps |
| ğŸŸ¡ P2 | Webhook site validation | api/webhooks | Easy | Wrong site routing |
| ğŸŸ¡ P2 | Refund receipt queue | lib/receipts.ts | Medium | Missing refunds |
| ğŸŸ¡ P2 | Fix OR logic in settings | api/receipts/settings | Easy | Wrong company match |
| ğŸŸ¢ P3 | Remove debug endpoints | api/debug/* | Easy | Security |
| ğŸŸ¢ P3 | Add audit logging | lib/db.ts | Medium | Compliance |
| ğŸŸ¢ P3 | API documentation | docs/ | Medium | Maintainability |

---

## Ğ—Ğ°ĞºĞ»ÑÑ‡ĞµĞ½Ğ¸Ğµ

**UDITO Ğµ Ñ„ÑƒĞ½ĞºÑ†Ğ¸Ğ¾Ğ½Ğ°Ğ»Ğ½Ğ¾ Ğ¿Ñ€Ğ¸Ğ»Ğ¾Ğ¶ĞµĞ½Ğ¸Ğµ**, ĞºĞ¾ĞµÑ‚Ğ¾ Ğ¸Ğ·Ğ¿ÑŠĞ»Ğ½ÑĞ²Ğ° Ğ¾ÑĞ½Ğ¾Ğ²Ğ½Ğ°Ñ‚Ğ° ÑĞ¸ Ğ·Ğ°Ğ´Ğ°Ñ‡Ğ° - Ğ¸Ğ·Ğ´Ğ°Ğ²Ğ°Ğ½Ğµ Ğ½Ğ° Ğ±ĞµĞ»ĞµĞ¶ĞºĞ¸ Ğ¿Ñ€Ğ¸ Ğ¿Ğ»Ğ°Ñ‰Ğ°Ğ½Ğµ. ĞĞ±Ğ°Ñ‡Ğµ Ğ¸Ğ¼Ğ° **ÑĞµÑ€Ğ¸Ğ¾Ğ·Ğ½Ğ¸ multi-tenancy Ğ¿Ñ€Ğ¾Ğ±Ğ»ĞµĞ¼Ğ¸**, ĞºĞ¾Ğ¸Ñ‚Ğ¾ Ğ¼Ğ¾Ğ³Ğ°Ñ‚ Ğ´Ğ° Ğ´Ğ¾Ğ²ĞµĞ´Ğ°Ñ‚ Ğ´Ğ¾:

1. **Data leaks** Ğ¼ĞµĞ¶Ğ´Ñƒ ĞºĞ»Ğ¸ĞµĞ½Ñ‚Ğ¸ (ĞºÑ€Ğ¸Ñ‚Ğ¸Ñ‡Ğ½Ğ¾)
2. **Ğ“Ñ€ĞµÑˆĞ½Ğ¸ Ğ½Ğ¾Ğ¼ĞµÑ€Ğ° Ğ½Ğ° Ğ±ĞµĞ»ĞµĞ¶ĞºĞ¸** (ĞºÑ€Ğ¸Ñ‚Ğ¸Ñ‡Ğ½Ğ¾)
3. **Race conditions** Ğ¿Ñ€Ğ¸ Ğ¿Ğ°Ñ€Ğ°Ğ»ĞµĞ»Ğ½Ğ¸ Ğ¾Ğ¿ĞµÑ€Ğ°Ñ†Ğ¸Ğ¸
4. **Ğ—Ğ°Ğ³ÑƒĞ±ĞµĞ½Ğ¸ refund Ğ±ĞµĞ»ĞµĞ¶ĞºĞ¸**

### ĞŸÑ€ĞµĞ¿Ğ¾Ñ€ÑŠÑ‡Ğ¸Ñ‚ĞµĞ»ĞµĞ½ Ğ¿Ğ»Ğ°Ğ½:

1. **Ğ’ĞµĞ´Ğ½Ğ°Ğ³Ğ°** - Ğ¤Ğ°Ğ·Ğ° 1 Ğ¿Ğ¾Ğ¿Ñ€Ğ°Ğ²ĞºĞ¸ (P0 Ğ·Ğ°Ğ´Ğ°Ñ‡Ğ¸)
2. **Ğ¢Ğ°Ğ·Ğ¸ ÑĞµĞ´Ğ¼Ğ¸Ñ†Ğ°** - Ğ¤Ğ°Ğ·Ğ° 2 Ğ¿Ğ¾Ğ¿Ñ€Ğ°Ğ²ĞºĞ¸ (P1 Ğ·Ğ°Ğ´Ğ°Ñ‡Ğ¸)
3. **Ğ¡Ğ»ĞµĞ´Ğ²Ğ°Ñ‰Ğ°Ñ‚Ğ° ÑĞµĞ´Ğ¼Ğ¸Ñ†Ğ°** - Ğ¤Ğ°Ğ·Ğ° 3 Ğ¿Ğ¾Ğ´Ğ¾Ğ±Ñ€ĞµĞ½Ğ¸Ñ (P2 Ğ·Ğ°Ğ´Ğ°Ñ‡Ğ¸)
4. **Ongoing** - Ğ¤Ğ°Ğ·Ğ° 4 cleanup (P3 Ğ·Ğ°Ğ´Ğ°Ñ‡Ğ¸)

**ĞĞµ ÑĞµ Ğ¿Ñ€ĞµĞ¿Ğ¾Ñ€ÑŠÑ‡Ğ²Ğ° Ğ´Ğ¾Ğ±Ğ°Ğ²ÑĞ½ĞµÑ‚Ğ¾ Ğ½Ğ° Ğ½Ğ¾Ğ²Ğ¸ ĞºĞ»Ğ¸ĞµĞ½Ñ‚Ğ¸ Ğ¿Ñ€ĞµĞ´Ğ¸ Ğ·Ğ°Ğ²ÑŠÑ€ÑˆĞ²Ğ°Ğ½Ğµ Ğ½Ğ° Ğ¤Ğ°Ğ·Ğ° 1.**

---

*Ğ”Ğ¾ĞºÑƒĞ¼ĞµĞ½Ñ‚ Ğ³ĞµĞ½ĞµÑ€Ğ¸Ñ€Ğ°Ğ½ Ğ¾Ñ‚ Claude Code Ğ°Ğ½Ğ°Ğ»Ğ¸Ğ·*
